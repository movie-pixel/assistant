<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>動画制作マネージャー</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Noto Sans JP -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Import Map for React, Lucide, and Firebase -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
    
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
        }
        @media print {
            @page { size: landscape; margin: 5mm; }
            body { 
                background: white; 
                -webkit-print-color-adjust: exact; 
                width: 100%;
                min-width: 0;
            }
            #root { zoom: 0.9; }

            /* 印刷時に隠す要素 */
            .print\:hidden, 
            .no-print, 
            button:not(.print\:show) { 
                display: none !important; 
            }

            .print\:shadow-none { box-shadow: none !important; }
            .print\:border-none { border: none !important; }
            .print\:w-full { width: 100% !important; max-width: none !important; }
            .print\:min-w-0 { min-width: 0 !important; }
            .print\:rounded-none { border-radius: 0 !important; }
            
            .overflow-x-auto { overflow: visible !important; }
            
            .max-w-\[1400px\] { max-width: none !important; padding: 0 !important; margin: 0 !important; }
            .min-w-\[900px\] { min-width: 0 !important; width: 100% !important; }

            textarea, input {
                border: none !important;
                resize: none !important;
                background: transparent !important;
                box-shadow: none !important;
                padding: 0 !important;
                min-height: auto !important;
                height: auto !important;
            }
            textarea::placeholder { color: transparent; }
            input[type="date"] { border-bottom: none !important; }

            .image-upload-area { display: none !important; }
            .print\:grid-cols-2 { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 0.5rem; }
            .break-inside-avoid { page-break-inside: avoid; }
        }
        
        input[type="date"] { position: relative; }
        input[type="date"]::-webkit-calendar-picker-indicator {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; cursor: pointer; padding: 0; margin: 0;
        }
        
        ::-webkit-scrollbar { height: 8px; width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useRef, useLayoutEffect, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Printer, FileText, Edit3, Image as ImageIcon, Clock, PenTool, Video, PlayCircle, Undo, Redo, Calendar as CalendarIcon, Users, MapPin, Briefcase, ChevronDown, MonitorPlay, Wifi, WifiOff, HardDrive, Settings, X, Save, Trash2, AlertCircle, Code, List, HelpCircle, RefreshCw, Link as LinkIcon, Check, ExternalLink, Plus, XCircle, Mic, Upload, Loader2 } from 'lucide-react';
        
        import { initializeApp, getApps } from "firebase/app";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "firebase/auth";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "firebase/firestore";

        let app, auth, db;
        const appId = 'storyboard-project-v1'; 
        let globalInitError = null;

        const defaultFirebaseConfig = {
            apiKey: "AIzaSyDnJf6vHEpdkjhjtnkLxzJaT4EGJgAw1lI",
            authDomain: "ekonte-a4b51.firebaseapp.com",
            projectId: "ekonte-a4b51",
            storageBucket: "ekonte-a4b51.firebasestorage.app",
            messagingSenderId: "402726001930",
            appId: "1:402726001930:web:65f70eb92369726c5ceef3"
        };

        const savedConfigStr = localStorage.getItem('firebase_config');
        let firebaseConfig = defaultFirebaseConfig; 

        if (savedConfigStr) {
            try {
                const parsed = JSON.parse(savedConfigStr);
                if (parsed && parsed.apiKey && parsed.projectId) {
                    firebaseConfig = parsed;
                } else {
                    localStorage.removeItem('firebase_config');
                }
            } catch (e) {
                console.error("Failed to parse saved firebase config", e);
            }
        }

        if (firebaseConfig) {
            try {
                if (!getApps().length) {
                    app = initializeApp(firebaseConfig);
                } else {
                    app = getApps()[0];
                }
                auth = getAuth(app);
                db = getFirestore(app);
                console.log("Firebase initialized successfully with:", firebaseConfig.projectId);
            } catch (e) {
                console.error("Firebase Init Error:", e);
                globalInitError = e.message;
                app = null; auth = null; db = null;
            }
        }

        const getProjectIdFromUrl = () => {
            const hash = window.location.hash.substring(1); 
            if (hash) return decodeURIComponent(hash);
            const params = new URLSearchParams(window.location.search);
            if (params.get('id')) return params.get('id');
            return 'demo';
        };

        // 画像圧縮関数 (容量削減のためさらに強く圧縮: 幅300px, 画質0.5)
        const compressImage = (file, maxWidth = 300, quality = 0.5) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                            height = Math.round((height * maxWidth) / width);
                            width = maxWidth;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.onerror = (error) => reject(error);
                };
                reader.onerror = (error) => reject(error);
            });
        };
        
        const checkDataSize = (data) => {
            const jsonString = JSON.stringify(data);
            return new TextEncoder().encode(jsonString).length;
        };

        // --- Data Templates ---
        const migrateCutData = (cut) => {
            if (!cut.images && cut.image) {
                return { ...cut, images: [cut.image] };
            }
            if (!cut.images) {
                return { ...cut, images: [] };
            }
            return cut;
        };

        const patternA_Data = {
            type: 'storyboard',
            header: { title: "『入院することになって…』(A案)", page: "1 / 1" },
            cuts: [
                { id: "CUT1-1", title: "来店", camera: "固定（三脚）", visuals: "画①〈固定〉：店舗入口と店内全体\n画②〈固定〉：スタッフが立ち上がる", images: [], seconds: "", dialogue: [{ speaker: "スタッフ", text: "「いらっしゃいませ。今日はどうされましたか？」" }], notes: "押さえる画：店舗入口と店内全体、スタッフが立ち上がる", feedback: "" },
                { id: "CUT1-2", title: "カウンターへ移動・着席", camera: "ジンバル", visuals: "画③〈ジンバル〉：お客様後ろからカウンター方向へ移動\n画④〈ジンバル〉：着席する動きまで追う\n画⑤〈ジンバル〉：向かい合った位置で止める", images: [], seconds: "", dialogue: [{ speaker: "お客様", text: "「実は今度入院することになったんですが…\n\n保険金の請求のことがよくわからなくて」" }, { speaker: "スタッフ", text: "「そうでしたか」" }], notes: "", feedback: "" },
                { id: "CUT2", title: "受け止め", camera: "固定（三脚）", visuals: "画①〈固定〉：スタッフ正面・上半身\n画②〈固定〉：スタッフ表情寄り\n画③〈固定〉：お客様の手元", images: [], seconds: "", dialogue: [{ speaker: "スタッフ", text: "「それはご不安ですよね。\n\n私たちがしっかりお手伝いしますので、ご安心ください」" }, { speaker: "お客様", text: "「ありがとうございます」" }], notes: "", feedback: "" },
                { id: "CUT3", title: "カルテ確認", camera: "固定（三脚）", visuals: "画①〈固定〉：ノートPCと操作する手元\n画②〈固定〉：肩越しでPCを見るスタッフ\n画③〈固定〉：画面を見てうなずくスタッフ", images: [], seconds: "", dialogue: [{ speaker: "スタッフ", text: "「ご入院はいつからのご予定ですか？」" }, { speaker: "お客様", text: "「来週の火曜日からです。膝の手術で」" }, { speaker: "スタッフ", text: "「そうなんですね」" }], notes: "", feedback: "" },
                { id: "CUT4", title: "過去の記録", camera: "固定（三脚）", visuals: "画①〈固定〉：スタッフ斜め前・上半身\n画②〈固定〉：カルテ画面（文字は映らない）\n画③〈固定〉：お客様の手元", images: [], seconds: "", dialogue: [{ speaker: "スタッフ", text: "「10年前にこの保険にご加入いただいた時も、\n\nお子様に迷惑をかけたくないと記録があります」" }, { speaker: "お客様", text: "「…そうでしたね」" }, { speaker: "スタッフ", text: "「でも、私たちのことは頼ってくださいね」" }, { speaker: "お客様", text: "「はい」" }], notes: "", feedback: "" },
                { id: "CUT5", title: "手続き説明", camera: "固定（三脚）", visuals: "画①〈固定〉：テーブル俯瞰で書類を並べる\n画②〈固定〉：指差しアップ\n画③〈固定〉：書類をそろえる手元", images: [], seconds: "", dialogue: [{ speaker: "スタッフ", text: "「それでは給付金のご請求方法をご案内しますね。\n\nまず病院から診断書をもらっていただいて…」" }, { speaker: "お客様", text: "「なるほど」" }], notes: "", feedback: "" },
                { id: "CUT6", title: "記入例を渡す", camera: "固定（三脚)", visuals: "画①〈固定〉：記入例アップ\n画②〈固定〉：お客様側から見た書類", images: [], seconds: "", dialogue: [{ speaker: "スタッフ", text: "「わかりにくい所もあるので、\n\nご記入例もお渡ししますね」" }, { speaker: "お客様", text: "「助かります」" }], notes: "", feedback: "" },
                { id: "CUT7", title: "家族への共有提案", camera: "固定（三脚）", visuals: "画①〈固定〉：書類が2部並んでいる状態\n画②〈固定〉：きちんとファイル2冊\n画③〈固定〉：お客様の手が止まる", images: [], seconds: "", dialogue: [{ speaker: "スタッフ", text: "「こちら2部ご用意しましたので、\n\n念のため1部はお子様にお渡しください」" }, { speaker: "お客様", text: "「子どもにですか…」" }, { speaker: "スタッフ", text: "「万一のときに、\n\nどんな保険に入っているかが分かるだけでも、\n\nご家族は安心できると思います」" }, { speaker: "お客様", text: "「…そうですね」" }], notes: "", feedback: "" },
                { id: "CUT8", title: "想いを伝える", camera: "固定（三脚)", visuals: "画①〈固定〉：スタッフ表情\n画②〈固定〉：ファイルに手を置く手元", images: [], seconds: "", dialogue: [{ speaker: "スタッフ", text: "「保険のことを共有しておくと、\n\nいざという時に慌てずに済むと思います」" }, { speaker: "お客様", text: "「確かにそうですね」" }], notes: "", feedback: "" },
                { id: "CUT9", title: "安心の反応", camera: "固定（三脚)", visuals: "画①〈固定〉：ファイルを受け取る手元\n画②〈固定〉：少し間を置いた静止カット", images: [], seconds: "", dialogue: [{ speaker: "お客様", text: "「相談したら、なんだかホッとしました」" }], notes: "", feedback: "" },
                { id: "CUT10", title: "見送り・退店後", camera: "ジンバル", visuals: "画①〈ジンバル〉：お客様後ろ姿で出口へ\n画②〈ジンバル〉：スタッフが席に戻る\n画③〈ジンバル〉：PC（カルテ）を閉じる\n画④〈ジンバル〉：店舗ロゴまたは外観", images: [], seconds: "", dialogue: [{ speaker: "スタッフ", text: "「どうかお身体を大切に。\n\n一日も早いご回復をお祈りしています」" }, { speaker: "お客様", text: "「ありがとうございます」" }], notes: "", feedback: "" }
            ]
        };

        const patternB_Data = {
            type: 'storyboard',
            header: { title: "『保険料を下げたい…』(B案)", page: "1 / 1" },
            cuts: [
                { id: "CUT1-1", title: "来店", camera: "固定（三脚）", visuals: "画①〈固定〉：店舗入口と店内全体\n画②〈固定〉：スタッフが立ち上がる", images: [], seconds: "", dialogue: [{ speaker: "お客様", text: "「初めてなんですが、相談できますか？」" }, { speaker: "スタッフ", text: "「いらっしゃいませ。今日はどうされましたか？」" }], notes: "", feedback: "" },
                // 他のカットも同様に images: [] を追加または既存データをマイグレーション時に対応
            ]
        };
        const normalizeData = (data) => {
             if(!data || !data.cuts) return data;
             return { ...data, cuts: data.cuts.map(migrateCutData) };
        };
        const patternC_Data = { type: 'storyboard', header: { title: "『お伝えしたいことがあります』(C案)", page: "1 / 1" }, cuts: [] }; 
        const initialCallSheet = {
            type: 'callsheet',
            header: { title: "撮影香盤表", location: "〇〇保険ショップ 新宿店", collection: "08:00 現地集合" },
            rows: [
                { time: "09:00～10:00", scene: "-", location: "全体", action: "設営・準備", cast: "スタッフ全員", notes: "機材搬入含む" },
                { time: "10:00～12:00", scene: "午前", location: "インタビューエリア", action: "インタビュー撮影\n(人事担当者：説明多め → 社員3名：サクサク進行)", cast: "人事担当者、社員3名", notes: "午前中に完了させる" },
                { time: "12:00～13:00", scene: "-", location: "休憩室 / スタジオ", action: "昼休憩・セットチェンジ", cast: "全スタッフ", notes: "会議机を接客カウンター風に配置換え" },
                { time: "13:00～16:30", scene: "午後", location: "カウンターセット", action: "ドラマパート撮影\n(3パターン撮影)", cast: "店員役、お客様役", notes: "A/B/C案 順次撮影" },
                { time: "16:30～17:00", scene: "ブツ撮り", location: "エントランス他", action: "インサート撮影\n(カルテ、ファイル、オフィスエントランス)", cast: "-", notes: "自然光の状況確認" },
                { time: "17:30～18:30", scene: "-", location: "-", action: "完全撤収", cast: "全スタッフ", notes: "原状回復確認" },
            ]
        };

        const initialInterviewData = {
            sections: [
                {
                    category: "働き方を知りたい",
                    items: [
                        {
                            title: "インタビュー①｜スタッフの1日",
                            qa: [
                                { q: "Q1. 普段の1日の流れを教えてください。", a: "【回答例】\n\n出社したらまず開店準備とメールの確認をして、朝礼で情報共有をします。その後はお客様対応を中心に、合間で事務作業も行います。" },
                                { q: "Q2. 出社して最初に行うことは何ですか？", a: "【回答例】\n\n店内の準備と、その日の予約や連絡事項のチェックですね。" },
                                { q: "Q3. お客様対応以外には、どんな業務がありますか？", a: "【回答例】\n\n相談内容の履歴入力や、満期のチェック、必要に応じたフォローの連絡などです。" },
                                { q: "Q4. 仕事で大切にしていることは何ですか？", a: "【回答例】\n\nお客様が安心して話せるように、まずしっかり話を聞くことです。" },
                                { q: "Q5. 1日を終えて達成感を感じるのはどんな時ですか？", a: "【回答例】\n\n「来てよかった」と言っていただけた時ですね。" }
                            ]
                        },
                        {
                            title: "インタビュー②｜働く店舗",
                            qa: [
                                { q: "Q1. この店舗の特徴を教えてください。", a: "【回答例】\n\n地域のお客様が多く、リピーターの方が多い店舗です。" },
                                { q: "Q2. どんなお客様が来られますか？", a: "【回答例】\n\nご家族連れや、ご年配の方の相談が多いですね。" },
                                { q: "Q3. 勤務地や転勤について教えてください。", a: "【回答例】\n\nエリア限定で働けるので、基本的に転勤はありません。" },
                                { q: "Q4. 店舗の雰囲気はどんな感じですか？", a: "【回答例】\n\n落ち着いていて、相談しやすい雰囲気だと思います。" },
                                { q: "Q5. 働きやすさを感じる点は？", a: "【回答例】\n\n困った時にすぐ相談できるところです。" }
                            ]
                        }
                    ]
                },
                {
                    category: "キャリアアップを知りたい",
                    items: [
                        {
                            title: "インタビュー③｜入社後研修・キャリアアップ",
                            qa: [
                                { q: "Q1. 入社後はどんな研修から始まりますか？", a: "【回答例】\n\n基礎知識から学べる研修からスタートします。" },
                                { q: "Q2. 未経験でも本当に大丈夫でしたか？", a: "【回答例】\n\n私自身も未経験でしたが、問題ありませんでした。" },
                                { q: "Q3. 研修ではどんなことを学びますか？", a: "【回答例】\n\n知識だけでなく、お客様との向き合い方も学びます。" },
                                { q: "Q4. 成長や評価はどのように決まりますか？", a: "【回答例】\n\nできることが増えると、評価や昇給につながります。" },
                                { q: "Q5. 将来のキャリアにはどんな選択肢がありますか？", a: "【回答例】\n\nリーダーや育成側に進む道もあります。" }] }] },
                { category: "社員を知りたい", items: [{ title: "インタビュー④｜社員A（育休・復帰）", qa: [{ q: "Q1. 今はどんな働き方をしていますか？", a: "【回答例】\n\n現在は時短勤務で働いています。" }, { q: "Q2. 育休前に不安だったことは何ですか？", a: "【回答例】\n\n仕事と育児の両立が一番不安でした。" }, { q: "Q3. 実際に復帰してみてどうでしたか？", a: "【回答例】\n\n周囲のサポートがあって、安心して復帰できました。" }, { q: "Q4. 働き続けられている理由は何ですか？", a: "【回答例】\n\n自分の状況に合わせて働ける環境があるからです。" }, { q: "Q5. 同じ立場の方に伝えたいことは？", a: "【回答例】\n\n無理せず続けられる職場だと思います。" }] }, { title: "インタビュー⑤｜社員B（新卒→リーダー）", qa: [{ q: "Q1. 新卒でこの会社を選んだ理由は？", a: "【回答例】\n\n人と長く関われる仕事だと思ったからです。" }, { q: "Q2. 入社当初、不安だったことはありますか？", a: "【回答例】\n\n知識面の不安はありました。" }, { q: "Q3. 成長を実感したタイミングは？", a: "【回答例】\n\n一人でお客様対応ができるようになった時です。" }, { q: "Q4. リーダーになって変わったことは？", a: "【回答例】\n\n周りを見て動く意識が強くなりました。" }, { q: "Q5. これから入社する方へ一言お願いします。", a: "【回答例】\n\n未経験でも安心して挑戦してほしいです。" }] }, { title: "インタビュー⑥｜社員C（保険会社から転職）", qa: [{ q: "Q1. 前職ではどんな仕事をしていましたか？", a: "【回答例】\n\n保険会社で営業の仕事をしていました。" }, { q: "Q2. 転職を考えたきっかけは？", a: "【回答例】\n\nもっとお客様に寄り添いたいと思ったからです。" }, { q: "Q3. 今の仕事で一番違うと感じる点は？", a: "【回答例】\n\n売るより、相談に乗る時間が長いところです。" }, { q: "Q4. やりがいはどう変わりましたか？", a: "【回答例】\n\n感謝の言葉を直接いただけるようになりました。" }, { q: "Q5. 転職を迷っている方へ一言。", a: "【回答例】\n\n保険の仕事の見方が変わると思います。" }] }] },
                { category: "会社を知りたい", items: [{ title: "インタビュー⑦｜会社概要", qa: [{ q: "Q1. どんな会社ですか？", a: "【回答例】\n\n保険のサービスショップを運営している会社です。" }, { q: "Q2. いつ創業した会社ですか？", a: "【回答例】\n\n1998年に創業しました。" }, { q: "Q3. 他社との違いは何ですか？", a: "【回答例】\n\n売ることより、支えることを大切にしています。" }] }, { title: "インタビュー⑧｜事業内容", qa: [{ q: "Q1. どんなサービスを提供していますか？", a: "【回答例】\n\n相談や給付手続き、見直しなどを行っています。" }, { q: "Q2. お客様とはどんな関係性ですか？", a: "【回答例】\n\n長く付き合っていく関係です。" }, { q: "Q3. 仕事の特徴を教えてください？", a: "【回答例】\n\n困った時に頼ってもらえる仕事です。" }] }, { title: "インタビュー⑨｜創業のはなし", qa: [{ q: "Q1. 創業のきっかけは何だったのですか？", a: "【回答例】\n\n保険で困った時に相談できる場所を作りたかったからです。" }, { q: "Q2. 当時、大変だったことは？", a: "【回答例】\n\n前例がなく、すべて手探りでした。" }, { q: "Q3. 今につながっている想いは？", a: "【回答例】\n\nお客様第一という考え方です。" }] }, { title: "インタビュー⑩｜目指していること", qa: [{ q: "Q1. 今後どんな会社を目指していますか？", a: "【回答例】\n\nかかりつけの保険サービスを広げていきたいです。" }, { q: "Q2. 社員にはどんな働き方をしてほしいですか？", a: "【回答例】\n\n誇りを持って働いてほしいです。" }] }, { title: "インタビュー⑪｜募集要項（まとめ）", qa: [{ q: "Q1. 今回募集している職種を教えてください。", a: "【回答例】\n\n保険サービススタッフです。" }, { q: "Q2. どんな方に向いていますか？", a: "【回答例】\n\n人の話を聞くのが好きな方です。" }, { q: "Q3. 未経験でも応募できますか？", a: "【回答例】\n\n研修があるので問題ありません。" }, { q: "Q4. 応募を迷っている方へ一言。", a: "【回答例】\n\nまずは気軽に話を聞きに来てほしいです。" }] }] }
            ]
        };

        const initialProjectData = {
            common: { clientName: "株式会社〇〇", projectName: "2026年 採用動画制作", date: "2026-01-11" },
            patternA: patternA_Data,
            patternB: normalizeData(patternB_Data),
            patternC: patternC_Data,
            callSheet: initialCallSheet,
            interview: initialInterviewData
        };

        // --- Components ---

        const AutoResizeTextarea = ({ value, onChange, onBlur, className, placeholder, rows = 1, style }) => {
            const textareaRef = useRef(null);
            
            const adjustHeight = () => {
                if (textareaRef.current) {
                    textareaRef.current.style.height = "auto";
                    textareaRef.current.style.height = `${textareaRef.current.scrollHeight}px`;
                }
            };

            useLayoutEffect(() => { adjustHeight(); }, [value]);
            
            useEffect(() => {
                const timer = setTimeout(adjustHeight, 100);
                window.addEventListener('resize', adjustHeight);
                return () => {
                    clearTimeout(timer);
                    window.removeEventListener('resize', adjustHeight);
                };
            }, []);

            return <textarea ref={textareaRef} className={`${className} overflow-hidden`} value={value} onChange={(e) => { onChange(e); adjustHeight(); }} onBlur={onBlur} placeholder={placeholder} rows={rows} style={style} />;
        };

        // Settings Modal (省略)
        function SettingsModal({ isOpen, onClose, initialError }) {
             const [mode, setMode] = useState('simple'); 
             const [apiKey, setApiKey] = useState('');
             const [authDomain, setAuthDomain] = useState('');
             const [projectId, setProjectId] = useState('');
             const [configJson, setConfigJson] = useState('');
             const [error, setError] = useState(initialError);
             useEffect(() => {
                if (isOpen) {
                    setError(initialError); 
                    const saved = localStorage.getItem('firebase_config');
                    if (saved) {
                        try { const parsed = JSON.parse(saved); setApiKey(parsed.apiKey||''); setAuthDomain(parsed.authDomain||''); setProjectId(parsed.projectId||''); setConfigJson(JSON.stringify(parsed,null,2)); } catch(e) { setConfigJson(saved||''); }
                    } else if (defaultFirebaseConfig) {
                        setApiKey(defaultFirebaseConfig.apiKey||''); setAuthDomain(defaultFirebaseConfig.authDomain||''); setProjectId(defaultFirebaseConfig.projectId||'');
                    }
                }
             }, [isOpen, initialError]);
             const handleSave = () => {
                 let config = null;
                 try {
                     if (mode === 'simple') {
                         if (!apiKey.trim() || !authDomain.trim() || !projectId.trim()) { localStorage.removeItem('firebase_config'); window.location.reload(); return; }
                         config = { ...defaultFirebaseConfig, apiKey: apiKey.trim(), authDomain: authDomain.trim(), projectId: projectId.trim() };
                     } else {
                         if (!configJson.trim()) { localStorage.removeItem('firebase_config'); window.location.reload(); return; }
                         config = JSON.parse(configJson);
                     }
                     localStorage.setItem('firebase_config', JSON.stringify(config)); window.location.reload();
                 } catch(e) { setError("JSONの形式が正しくありません。"); }
             };
             const handleDelete = () => {
                if(confirm("設定を完全に削除してオフラインモードにしますか？")) {
                    localStorage.setItem('firebase_config', '{}');
                    window.location.reload();
                }
             };
             if(!isOpen) return null;
             return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-md p-6 overflow-y-auto max-h-[90vh]">
                        <div className="flex justify-between items-center mb-4 border-b pb-2">
                             <h3 className="font-bold text-lg flex items-center gap-2"><Settings className="w-5 h-5"/> 接続設定</h3>
                             <button onClick={onClose}><X className="w-5 h-5 text-slate-400" /></button>
                        </div>
                        {error && <div className="mb-4 text-xs text-red-600 bg-red-50 p-2 rounded">{error}</div>}
                        <div className="space-y-4">
                            {mode==='simple' ? (
                                <>
                                <div><label className="text-xs font-bold text-slate-500">API Key</label><input className="w-full border rounded p-2 text-sm" value={apiKey} onChange={e=>setApiKey(e.target.value)} placeholder="AIza..." /></div>
                                <div><label className="text-xs font-bold text-slate-500">Auth Domain</label><input className="w-full border rounded p-2 text-sm" value={authDomain} onChange={e=>setAuthDomain(e.target.value)} placeholder="...firebaseapp.com" /></div>
                                <div><label className="text-xs font-bold text-slate-500">Project ID</label><input className="w-full border rounded p-2 text-sm" value={projectId} onChange={e=>setProjectId(e.target.value)} placeholder="project-id" /></div>
                                </>
                            ) : (
                                <textarea className="w-full border rounded p-2 text-xs font-mono h-32" value={configJson} onChange={e=>setConfigJson(e.target.value)} />
                            )}
                            <div className="flex justify-between items-center pt-2">
                                <button onClick={handleDelete} className="text-xs text-red-500 hover:text-red-700 flex items-center gap-1"><Trash2 className="w-3 h-3"/>設定削除</button>
                                <div className="flex gap-2">
                                    <button onClick={()=>setMode(mode==='simple'?'json':'simple')} className="text-xs text-blue-500 mr-auto self-center px-2">モード切替</button>
                                    <button onClick={onClose} className="px-3 py-1 text-slate-500 text-sm border rounded hover:bg-slate-100">キャンセル</button>
                                    <button onClick={handleSave} className="px-4 py-1 bg-blue-600 text-white rounded text-sm font-bold hover:bg-blue-700">保存</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
             );
        }

        function StoryboardEditor({ data, common, onUpdate }) {
            const fileInputRefs = useRef([]);

            const handleCutUpdate = (index, field, value) => {
                const newCuts = [...data.cuts];
                newCuts[index] = { ...newCuts[index], [field]: value };
                onUpdate({ ...data, cuts: newCuts });
            };

            const handleDialogueUpdate = (cutIndex, dIndex, field, value) => {
                const newCuts = [...data.cuts];
                const newDialogue = [...newCuts[cutIndex].dialogue];
                newDialogue[dIndex] = { ...newDialogue[dIndex], [field]: value };
                newCuts[cutIndex] = { ...newCuts[cutIndex], dialogue: newDialogue };
                onUpdate({ ...data, cuts: newCuts });
            };

            // 複数画像追加 (圧縮処理付き)
            const handleImageAdd = async (index, e) => {
                const files = e.target.files;
                if (files && files.length > 0) {
                    const newImages = [];
                    for (let i = 0; i < files.length; i++) {
                        try {
                            const compressed = await compressImage(files[i], 300, 0.5); // 強圧縮
                            newImages.push(compressed);
                        } catch (err) { console.error("Image compression failed", err); }
                    }
                    const currentCuts = [...data.cuts];
                    const currentImages = currentCuts[index].images || [];
                    const updatedImages = [...currentImages, ...newImages];
                    
                    currentCuts[index] = { ...currentCuts[index], images: updatedImages, image: null }; 
                    onUpdate({ ...data, cuts: currentCuts });
                }
                e.target.value = '';
            };

            const handleImageDelete = (cutIndex, imgIndex, e) => {
                e.stopPropagation(); 
                e.preventDefault();
                if(!window.confirm("この画像を削除しますか？")) return;
                
                const newCuts = [...data.cuts];
                const cutCopy = { ...newCuts[cutIndex] };
                const newImages = [...(cutCopy.images || (cutCopy.image ? [cutCopy.image] : []))];
                
                newImages.splice(imgIndex, 1);
                cutCopy.images = newImages;
                cutCopy.image = null; 
                newCuts[cutIndex] = cutCopy;
                onUpdate({ ...data, cuts: newCuts });
            };

            const handlePaste = async (index, e) => {
                const items = e.clipboardData.items;
                let foundImage = false;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        foundImage = true;
                        const blob = items[i].getAsFile();
                        try {
                            const compressed = await compressImage(blob, 300, 0.5); // 強圧縮
                            const currentCuts = [...data.cuts];
                            const currentImages = currentCuts[index].images || [];
                            const updatedImages = [...currentImages, compressed];
                            currentCuts[index] = { ...currentCuts[index], images: updatedImages, image: null };
                            onUpdate({ ...data, cuts: currentCuts });
                        } catch (err) { console.error("Paste error", err); }
                        break; 
                    }
                }
                if (foundImage) { e.preventDefault(); e.stopPropagation(); }
            };

            const calculateEstimatedTime = (dialogue) => {
                const totalChars = dialogue.reduce((acc, line) => acc + line.text.replace(/[\s\u3000「」]/g, '').length, 0);
                return Math.max(1, Math.ceil(totalChars / 4));
            };

            let cumulativeTime = 0;

            return (
                <div className="min-w-[900px] print:min-w-0 print:w-full">
                    <div className="p-8 md:p-10 border-b border-slate-100 print:p-6 print:border-slate-800 bg-white">
                        <div className="mb-2 text-center">
                            <div className="text-sm font-bold text-slate-500 mb-2">{common.clientName} 御中</div>
                            <div className="text-xs font-bold text-slate-400 mb-1 tracking-wide">{common.projectName}</div>
                            <div className="text-3xl font-extrabold text-slate-900 tracking-tight text-center w-full">動画制作 絵コンテ</div>
                        </div>
                        <div className="flex justify-center flex-wrap gap-6 md:gap-12 text-sm text-slate-500 mt-6">
                            <div className="group flex flex-col items-start gap-1">
                                <span className="text-[10px] font-bold uppercase tracking-wider text-slate-400">案件名 / タイトル</span>
                                <input className="font-bold text-lg text-slate-900 bg-slate-50 border border-transparent hover:border-slate-200 focus:bg-white focus:border-indigo-500 rounded px-3 py-1 w-96 text-center" value={data.header.title} onChange={(e) => onUpdate({ ...data, header: { ...data.header, title: e.target.value } })} />
                            </div>
                            <div className="group flex flex-col items-start gap-1">
                                <span className="text-[10px] font-bold uppercase tracking-wider text-slate-400">撮影日</span>
                                <div className="font-medium text-lg text-slate-900 px-3 py-1 border-b border-slate-200 min-w-[120px] text-center">{common.date}</div>
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-[60px_3fr_3fr_3fr_80px_2fr] bg-slate-50 border-b border-slate-200 text-[11px] font-bold text-slate-500 uppercase tracking-widest print:bg-slate-100 print:border-slate-800 print:text-black">
                        <div className="p-3 text-center border-r border-slate-200 print:border-slate-400">No.</div>
                        <div className="p-3 text-center border-r border-slate-200 print:border-slate-400">画面 (イメージ)</div>
                        <div className="p-3 text-center border-r border-slate-200 print:border-slate-400">演出・カメラ</div>
                        <div className="p-3 text-center border-r border-slate-200 print:border-slate-400">セリフ</div>
                        <div className="p-3 text-center border-r border-slate-200 print:border-slate-400">時間</div>
                        <div className="p-3 text-center">備考・修正</div>
                    </div>

                    {data.cuts.map((cut, index) => {
                        const estimatedTime = calculateEstimatedTime(cut.dialogue);
                        const duration = cut.seconds !== "" ? parseInt(cut.seconds) : estimatedTime;
                        cumulativeTime += duration;
                        const displayTime = cut.seconds !== "" ? cut.seconds : estimatedTime;
                        const images = cut.images || (cut.image ? [cut.image] : []);

                        return (
                            <div key={cut.id} className="grid grid-cols-[60px_3fr_3fr_3fr_80px_2fr] border-b border-slate-100 last:border-none hover:bg-slate-50/50 transition-colors group break-inside-avoid print:border-slate-300">
                                <div className="p-4 border-r border-slate-100 flex flex-col items-center justify-center bg-slate-50/30 print:bg-white print:border-slate-400">
                                    <span className="text-xl font-bold text-slate-800 font-mono tracking-tighter">{cut.id}</span>
                                </div>
                                
                                <div 
                                    className="p-4 border-r border-slate-100 flex flex-col justify-start print:border-slate-400 outline-none focus:ring-4 focus:ring-blue-500/50 rounded-sm transition-all relative group/cell"
                                    tabIndex={0}
                                    onPaste={(e) => handlePaste(index, e)}
                                    onClick={(e) => {
                                        if (e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT') {
                                            e.currentTarget.focus();
                                        }
                                    }}
                                >
                                    <div className="mb-2 w-full">
                                        <AutoResizeTextarea className="w-full text-base font-bold text-slate-800 bg-transparent border-b border-transparent hover:border-slate-200 focus:border-indigo-500 focus:ring-0 px-1 py-0.5 resize-none leading-tight placeholder-slate-300 break-words whitespace-pre-wrap" value={cut.title} onChange={(e) => handleCutUpdate(index, 'title', e.target.value)} onBlur={() => {}} rows={1} placeholder="シーン名 / 役割" />
                                    </div>
                                    
                                    <div className="grid grid-cols-1 gap-2 print:grid-cols-2">
                                        {images.map((imgSrc, imgIdx) => (
                                            <div key={imgIdx} className="relative group/img aspect-video bg-white border border-slate-200 rounded overflow-hidden">
                                                <img src={imgSrc} alt={`Scene ${index}-${imgIdx}`} className="w-full h-full object-cover" />
                                                <button 
                                                    type="button"
                                                    onClick={(e) => handleImageDelete(index, imgIdx, e)}
                                                    className="absolute top-1 right-1 bg-gray-800/80 hover:bg-red-600 text-white rounded-full p-1.5 transition-colors z-20 cursor-pointer shadow-md opacity-0 group-hover/img:opacity-100 print:hidden" 
                                                    title="削除"
                                                >
                                                    <X size={14} strokeWidth={3} />
                                                </button>
                                            </div>
                                        ))}
                                        
                                        <div 
                                            className={`aspect-video w-full bg-white border-2 border-dashed border-slate-200 rounded-lg flex flex-col items-center justify-center text-slate-300 overflow-hidden relative cursor-pointer hover:border-indigo-400 hover:bg-indigo-50/10 transition-all group/add print:hidden`}
                                            onClick={() => fileInputRefs.current[index]?.click()}
                                            tabIndex={-1} 
                                        >
                                            <div className="flex flex-col items-center pointer-events-none">
                                                <Plus className="w-6 h-6 mb-1 text-slate-200 group-hover/add:text-indigo-300" />
                                                <span className="text-[10px] font-medium text-slate-400">画像追加 (Ctrl+V)</span>
                                            </div>
                                            <button 
                                                type="button"
                                                onClick={(e) => {
                                                    e.stopPropagation(); 
                                                    fileInputRefs.current[index]?.click();
                                                }}
                                                className="mt-2 text-[10px] text-indigo-400 hover:text-indigo-600 hover:underline z-10 cursor-pointer"
                                            >
                                                またはファイルを選択
                                            </button>
                                            <input type="file" accept="image/*" multiple className="hidden" ref={el => fileInputRefs.current[index] = el} onChange={(e) => handleImageAdd(index, e)} />
                                        </div>
                                    </div>
                                </div>
                                <div className="p-4 border-r border-slate-100 flex flex-col justify-center gap-4 print:border-slate-400">
                                    <div className="relative">
                                        <div className="flex items-center gap-1.5 mb-1.5">
                                            <span className="text-[10px] font-medium text-slate-700 uppercase tracking-wider">演出指示</span>
                                        </div>
                                        <AutoResizeTextarea className="w-full text-base font-medium text-slate-800 leading-relaxed bg-white border border-slate-200 rounded-md px-3 py-2 pb-3 focus:bg-white focus:ring-2 focus:ring-indigo-100 transition-all placeholder-slate-300 print:bg-transparent print:p-0 whitespace-pre-wrap break-words" value={cut.visuals} onChange={(e) => handleCutUpdate(index, 'visuals', e.target.value)} onBlur={() => {}} rows={6} />
                                    </div>
                                    <div className="relative pt-3 border-t border-slate-200 border-dashed print:border-slate-300">
                                        <div className="flex items-center gap-1.5 mb-1.5">
                                            <span className="text-[10px] font-medium text-slate-700 uppercase tracking-wider">カメラワーク</span>
                                        </div>
                                        <AutoResizeTextarea className="w-full text-base font-medium text-slate-800 bg-white border border-slate-200 rounded-md px-3 py-2 pb-3 focus:bg-white focus:ring-2 focus:ring-emerald-100 transition-all placeholder-slate-300 print:bg-transparent print:p-0 whitespace-pre-wrap break-words" value={cut.camera} onChange={(e) => handleCutUpdate(index, 'camera', e.target.value)} onBlur={() => {}} rows={2} />
                                    </div>
                                </div>
                                <div className="p-4 border-r border-slate-100 flex flex-col justify-center print:border-slate-400">
                                    <div className="space-y-4">
                                        {cut.dialogue.map((line, dIndex) => (
                                            <div key={dIndex} className="flex flex-col gap-1 border-l-4 border-slate-200 pl-3 hover:border-indigo-300 transition-colors print:border-none print:pl-0">
                                                <input className="text-sm font-bold text-slate-700 bg-transparent border-none focus:ring-0 p-0 mb-0.5" value={line.speaker} onChange={(e) => handleDialogueUpdate(index, dIndex, 'speaker', e.target.value)} onBlur={() => {}} placeholder="話者" />
                                                <AutoResizeTextarea className="w-full text-base font-medium text-slate-800 bg-white border border-slate-200 rounded p-2 pb-3 focus:ring-2 focus:ring-indigo-100 leading-relaxed whitespace-pre-wrap break-words" value={line.text} onChange={(e) => handleDialogueUpdate(index, dIndex, 'text', e.target.value)} onBlur={() => {}} rows={6} placeholder="セリフ" />
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div className="p-2 border-r border-slate-100 flex flex-col items-center justify-center bg-slate-50/30 print:bg-white print:border-slate-400">
                                    <div className="flex flex-col items-center mb-3">
                                        <div className="flex items-baseline justify-center gap-1">
                                            <input type="text" className={`w-14 text-center font-bold text-2xl bg-transparent border-b-2 focus:ring-0 p-1 transition-colors ${cut.seconds ? 'text-indigo-700 border-indigo-200' : 'text-slate-400 border-transparent hover:border-slate-200 focus:border-indigo-400 focus:text-slate-600'}`} value={displayTime} onChange={(e) => handleCutUpdate(index, 'seconds', e.target.value)} onBlur={() => {}} />
                                            <span className="text-sm font-medium text-slate-500">秒</span>
                                        </div>
                                        <span className="text-[10px] text-slate-500 mt-1 uppercase tracking-wider font-bold">目安</span>
                                    </div>
                                    <div className="flex flex-col items-center pt-2 border-t border-slate-200 w-full">
                                        <div className="flex items-center gap-1 text-slate-700">
                                            <PlayCircle className="w-4 h-4 text-slate-500" />
                                            <span className="text-sm font-mono font-bold">{cumulativeTime}秒</span>
                                        </div>
                                        <span className="text-[10px] text-slate-500 mt-0.5 uppercase tracking-wider font-bold">累計</span>
                                    </div>
                                </div>
                                <div className="p-4 flex flex-col gap-4 bg-yellow-50/20 print:bg-white">
                                    <div className="flex-1">
                                        <label className="text-[9px] font-bold text-slate-600 uppercase tracking-wider mb-2 block">備考</label>
                                        <AutoResizeTextarea className="w-full text-sm text-slate-700 bg-white border border-slate-200 rounded p-2 focus:bg-white focus:border-yellow-400 focus:ring-1 focus:ring-yellow-200 transition-all print:border-none print:p-0 whitespace-pre-wrap break-words" value={cut.notes} onChange={(e) => handleCutUpdate(index, 'notes', e.target.value)} onBlur={() => {}} rows={3} />
                                    </div>
                                    <div className="flex-1">
                                        <label className="text-[9px] font-bold text-rose-600 uppercase tracking-wider mb-2 block flex items-center gap-1"><PenTool className="w-3 h-3" />赤字修正</label>
                                        <AutoResizeTextarea className="w-full text-sm text-rose-700 font-medium bg-rose-50 border border-rose-200 rounded p-2 focus:bg-white focus:border-rose-400 focus:ring-1 focus:ring-rose-200 transition-all placeholder-rose-300 print:bg-transparent print:border-none print:p-0 whitespace-pre-wrap break-words" value={cut.feedback} onChange={(e) => handleCutUpdate(index, 'feedback', e.target.value)} onBlur={() => {}} rows={3} />
                                    </div>
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        }

        // Interview List Editor Component
        function InterviewListEditor({ data, onUpdate }) {
            const handleSectionUpdate = (secIdx, field, value) => {
                const newSections = [...(data.sections || [])];
                newSections[secIdx] = { ...newSections[secIdx], [field]: value };
                onUpdate({ ...data, sections: newSections });
            };

            const handleItemUpdate = (secIdx, itemIdx, field, value) => {
                const newSections = [...(data.sections || [])];
                newSections[secIdx].items[itemIdx] = { ...newSections[secIdx].items[itemIdx], [field]: value };
                onUpdate({ ...data, sections: newSections });
            };

            const handleQAUpdate = (secIdx, itemIdx, qaIdx, field, value) => {
                const newSections = [...(data.sections || [])];
                const newQA = [...newSections[secIdx].items[itemIdx].qa];
                newQA[qaIdx] = { ...newQA[qaIdx], [field]: value };
                newSections[secIdx].items[itemIdx].qa = newQA;
                onUpdate({ ...data, sections: newSections });
            };

            const sections = data?.sections || [];

            if (!data) return <div className="p-8 text-center text-slate-500">読み込み中...</div>;

            return (
                <div className="bg-white min-h-[800px] min-w-[900px] print:min-w-0 print:w-full p-8 md:p-10 print:p-6">
                    <h2 className="text-3xl font-black text-center mb-8 tracking-tight text-slate-900 border-b-2 border-slate-800 pb-4">インタビューリスト</h2>
                    
                    <div className="space-y-12">
                        {sections.map((section, secIdx) => (
                            <div key={secIdx} className="break-inside-avoid">
                                <div className="mb-4 border-b border-indigo-200 pb-2">
                                    <input 
                                        className="text-2xl font-bold text-indigo-700 bg-transparent border-none focus:ring-0 w-full"
                                        value={section.category}
                                        onChange={(e) => handleSectionUpdate(secIdx, 'category', e.target.value)}
                                        placeholder="カテゴリ名"
                                    />
                                </div>
                                <div className="grid grid-cols-1 gap-6">
                                    {section.items.map((item, itemIdx) => (
                                        <div key={itemIdx} className="bg-slate-50 rounded-xl border border-slate-200 p-6 shadow-sm break-inside-avoid">
                                            <input 
                                                className="text-lg font-bold text-slate-800 bg-transparent border-none focus:ring-0 w-full mb-4 border-b border-slate-200 pb-2"
                                                value={item.title}
                                                onChange={(e) => handleItemUpdate(secIdx, itemIdx, 'title', e.target.value)}
                                                placeholder="インタビュータイトル"
                                            />
                                            <div className="space-y-4">
                                                {item.qa.map((qa, qaIdx) => (
                                                    <div key={qaIdx} className="group">
                                                        <div className="mb-2">
                                                            <AutoResizeTextarea 
                                                                className="w-full text-sm font-bold text-slate-700 bg-white border border-slate-200 rounded p-2 focus:ring-2 focus:ring-indigo-100"
                                                                value={qa.q}
                                                                onChange={(e) => handleQAUpdate(secIdx, itemIdx, qaIdx, 'q', e.target.value)}
                                                                placeholder="質問"
                                                            />
                                                        </div>
                                                        <div>
                                                            <AutoResizeTextarea 
                                                                className="w-full text-sm text-slate-600 bg-white border border-slate-200 rounded p-2 focus:ring-2 focus:ring-indigo-100 min-h-[80px] whitespace-pre-wrap"
                                                                value={qa.a}
                                                                onChange={(e) => handleQAUpdate(secIdx, itemIdx, qaIdx, 'a', e.target.value)}
                                                                placeholder="回答"
                                                            />
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // Call Sheet Editor Component
        function CallSheetEditor({ data, common, onUpdate }) {
            const handleHeaderChange = (field, value) => onUpdate({ ...data, header: { ...data.header, [field]: value } });
            const handleRowChange = (index, field, value) => {
                const newRows = [...data.rows];
                newRows[index] = { ...newRows[index], [field]: value };
                onUpdate({ ...data, rows: newRows });
            };

            return (
                <div className="bg-white min-h-[800px] min-w-[900px] print:min-w-0 print:w-full">
                    <div className="p-8 md:p-10 border-b-2 border-slate-800 bg-slate-50 print:bg-white print:p-6 print:border-slate-800">
                        <h2 className="text-3xl font-black text-center mb-8 tracking-tight text-slate-900">撮影香盤表</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mx-auto">
                            <div className="space-y-4">
                                <div className="flex items-center gap-3"><span className="w-24 text-sm font-bold uppercase text-slate-500 tracking-wider">クライアント</span><div className="flex-1 font-bold text-xl border-b border-slate-300 px-1 py-0.5">{common.clientName}</div></div>
                                <div className="flex items-center gap-3"><span className="w-24 text-sm font-bold uppercase text-slate-500 tracking-wider">撮影日</span><div className="flex-1 font-medium text-lg border-b border-slate-300 px-1 py-0.5">{common.date}</div></div>
                            </div>
                            <div className="space-y-4">
                                <div className="flex items-center gap-3"><span className="w-24 text-sm font-bold uppercase text-slate-500 tracking-wider">場所 / ロケ地</span><input className="flex-1 font-medium text-lg border-b border-slate-300 focus:border-emerald-500 focus:ring-0 bg-transparent" value={data.header.location} onChange={(e) => handleHeaderChange('location', e.target.value)} /></div>
                                <div className="flex items-center gap-3"><span className="w-24 text-sm font-bold uppercase text-slate-500 tracking-wider">集合時間</span><input className="flex-1 font-bold text-xl text-emerald-700 border-b border-slate-300 focus:border-emerald-500 focus:ring-0 bg-transparent" value={data.header.collection} onChange={(e) => handleHeaderChange('collection', e.target.value)} /></div>
                            </div>
                        </div>
                    </div>
                    <div className="w-full">
                        <div className="grid grid-cols-[150px_1fr_1.5fr_2fr_1.5fr_1.5fr] bg-slate-800 text-white text-[12px] font-bold uppercase tracking-widest">
                            <div className="p-3 text-center border-r border-slate-700">時間 (00:00～00:00)</div>
                            <div className="p-3 text-center border-r border-slate-700">シーン</div>
                            <div className="p-3 text-center border-r border-slate-700">場所 / セット</div>
                            <div className="p-3 text-center border-r border-slate-700">アクション / 内容</div>
                            <div className="p-3 text-center border-r border-slate-700">キャスト</div>
                            <div className="p-3 text-center">備考</div>
                        </div>
                        {data.rows.map((row, index) => (
                            <div key={index} className="grid grid-cols-[150px_1fr_1.5fr_2fr_1.5fr_1.5fr] border-b border-slate-200 hover:bg-emerald-50/30 transition-colors group break-inside-avoid">
                                <div className="p-2 border-r border-slate-200"><input className="w-full text-center font-bold text-base bg-transparent border-none focus:ring-0 p-1" value={row.time} onChange={(e) => handleRowChange(index, 'time', e.target.value)} placeholder="00:00～00:00" /></div>
                                <div className="p-2 border-r border-slate-200 flex items-center justify-center"><input className="w-full text-center font-bold text-slate-800 bg-transparent border-none focus:ring-0 p-1" value={row.scene} onChange={(e) => handleRowChange(index, 'scene', e.target.value)} /></div>
                                <div className="p-2 border-r border-slate-200 flex items-center"><AutoResizeTextarea className="w-full text-base bg-transparent border-none focus:ring-0 resize-none text-center break-words" value={row.location} onChange={(e) => handleRowChange(index, 'location', e.target.value)} onBlur={() => {}} /></div>
                                <div className="p-2 border-r border-slate-200 flex items-center"><AutoResizeTextarea className="w-full text-base font-medium bg-transparent border-none focus:ring-0 resize-none break-words" value={row.action} onChange={(e) => handleRowChange(index, 'action', e.target.value)} onBlur={() => {}} /></div>
                                <div className="p-2 border-r border-slate-200 flex items-center"><AutoResizeTextarea className="w-full text-sm bg-transparent border-none focus:ring-0 resize-none text-slate-700 break-words" value={row.cast} onChange={(e) => handleRowChange(index, 'cast', e.target.value)} onBlur={() => {}} /></div>
                                <div className="p-2 flex items-center bg-yellow-50/10"><AutoResizeTextarea className="w-full text-sm text-slate-600 bg-transparent border-none focus:ring-0 resize-none break-words" value={row.notes} onChange={(e) => handleRowChange(index, 'notes', e.target.value)} onBlur={() => {}} /></div>
                            </div>
                        ))}
                    </div>
                    <div className="p-4 flex justify-center print:hidden border-t border-slate-200">
                        <button onClick={() => { const newRow = { time: "", scene: "", location: "", action: "", cast: "", notes: "" }; onUpdate({ ...data, rows: [...data.rows, newRow] }); }} className="text-sm text-emerald-600 font-bold hover:text-emerald-700 flex items-center gap-2 px-4 py-2 hover:bg-emerald-50 rounded transition-colors">+ 行を追加</button>
                    </div>
                </div>
            );
        }

        // Main App Component
        function StoryboardApp() {
            const [activeTab, setActiveTab] = useState('patternA');
            const [user, setUser] = useState(null);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [syncError, setSyncError] = useState(null);
            const [isLoading, setIsLoading] = useState(true); // ローディング状態を追加
            
            const projectId = getProjectIdFromUrl();
            
            // Initial load from local storage
            const [history, setHistory] = useState(() => {
                const saved = localStorage.getItem(`storyboard_data_${projectId}`);
                // 初期データにインタビューがない場合のフォールバック
                let initial = saved ? JSON.parse(saved) : initialProjectData;
                if (!initial.interview) initial.interview = initialProjectData.interview;
                return [initial];
            });
            const [historyIndex, setHistoryIndex] = useState(0);
            const currentData = history[historyIndex];

            // Setup Auth & Sync
            useEffect(() => {
                // Firebase未設定またはエラー時はローディング終了
                if (!auth) {
                    if (globalInitError) setSyncError("設定エラー: " + globalInitError);
                    setIsLoading(false);
                    return;
                }

                const initAuth = async () => {
                    try { 
                        await signInAnonymously(auth); 
                        setSyncError(null);
                    } catch (e) { 
                        console.error("Auth error", e);
                        setSyncError("認証エラー: 匿名認証が無効です。");
                        setIsLoading(false);
                    }
                };
                initAuth();
                
                return onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    if (u) {
                        // ログイン成功時にローディングを継続（Firestore同期待ち）
                    } else if (!globalInitError) {
                        // ログアウト時などはローディング終了
                         setIsLoading(false);
                    }
                });
            }, []);

            // Firestore Sync (Listen)
            useEffect(() => {
                if (!user || !db) return;
                const docRef = doc(collection(db, 'projects'), projectId);
                
                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        
                        // 【復旧ロジック】
                        // クラウドのデータが「デモデータ」と一致していて、
                        // ローカルに「編集済みデータ」がある場合、
                        // クラウドのデータをローカルのデータで上書きする（復旧）
                        const savedLocal = localStorage.getItem(`storyboard_data_${projectId}`);
                        let localData = savedLocal ? JSON.parse(savedLocal) : null;
                        
                        // 簡易判定: クライアント名が初期値ならデモとみなす
                        const isCloudDemo = data.common?.clientName === "株式会社〇〇";
                        const isLocalEdited = localData && localData.common?.clientName !== "株式会社〇〇";

                        if (isCloudDemo && isLocalEdited) {
                            console.log("Restoring Cloud data from Local (Cloud was demo)...");
                            saveToFirestore(localData); // 復旧実行
                            return; // 状態更新せずリターン
                        }

                        setHistory(prev => {
                            const current = prev[prev.length - 1];
                            if (JSON.stringify(current) === JSON.stringify(data)) return prev;
                            const migratedData = { 
                                ...data, 
                                patternA: normalizeData(data.patternA), 
                                patternB: normalizeData(data.patternB), 
                                patternC: normalizeData(data.patternC),
                                interview: data.interview || initialProjectData.interview 
                            };
                            const newHist = [...prev, migratedData];
                            setHistoryIndex(newHist.length - 1);
                            return newHist;
                        });
                    } else {
                         // クラウドにデータがない場合もローカルから復元
                         const saved = localStorage.getItem(`storyboard_data_${projectId}`);
                         if (saved) {
                             console.log("Restoring from Local Storage to Cloud (Cloud empty)...");
                             saveToFirestore(JSON.parse(saved));
                         } else if (isLoading) {
                             // 本当に何もない場合は初期データを保存
                             saveToFirestore(initialProjectData);
                         }
                    }
                    setIsLoading(false); // データ取得完了または初期化完了
                }, (error) => {
                    console.log("Sync error:", error);
                    setSyncError("同期エラー: " + error.code);
                    setIsLoading(false); // エラー時もローディング終了
                });
                return () => unsubscribe();
            }, [user, projectId]); 

            const checkDataSize = (data) => {
                const jsonString = JSON.stringify(data);
                return new TextEncoder().encode(jsonString).length;
            };

            const saveData = async (newData) => {
                localStorage.setItem(`storyboard_data_${projectId}`, JSON.stringify(newData));
                if (user && db) {
                    // データサイズチェック (1MB = 1,048,576 bytes)
                    const size = checkDataSize(newData);
                    if (size > 1000000) {
                        alert("データ容量が大きすぎます(約1MB超)。これ以上画像を保存できません。\n古い画像を削除するか、画質を下げてください。");
                        setSyncError("容量エラー: データが大きすぎます");
                        return;
                    }
                    saveToFirestore(newData);
                }
            };
            
            const saveToFirestore = async (newData) => {
                try {
                    const docRef = doc(collection(db, 'projects'), projectId);
                    await setDoc(docRef, newData);
                    setSyncError(null);
                } catch(e) { console.error("Cloud save failed", e); setSyncError("保存エラー"); }
            };

            const updateData = (newData) => {
                const newHistory = history.slice(0, historyIndex + 1);
                newHistory.push(newData);
                setHistory(newHistory);
                setHistoryIndex(newHistory.length - 1);
                saveData(newData);
            };

            const handleUndo = () => { if (historyIndex > 0) { setHistoryIndex(historyIndex - 1); saveData(history[historyIndex - 1]); } };
            const handleRedo = () => { if (historyIndex < history.length - 1) { setHistoryIndex(historyIndex + 1); saveData(history[historyIndex + 1]); } };
            const updateTabData = (key, val) => updateData({ ...currentData, [key]: val });
            const updateCommon = (key, val) => updateData({ ...currentData, common: { ...currentData.common, [key]: val } });
            
            const handleCopyLink = () => {
                const url = new URL(window.location.href);
                url.search = ''; url.hash = projectId;
                const urlString = url.toString();
                const textArea = document.createElement("textarea");
                textArea.value = urlString;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                textArea.style.top = "0";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try { document.execCommand('copy'); alert(`リンクをコピーしました: ${urlString}`); } catch (err) { alert('コピー失敗: ' + urlString); }
                document.body.removeChild(textArea);
            };
            
            const handleChangeId = () => {
                const newId = prompt("新しい共有IDを入力してください:", projectId);
                if (newId && newId !== projectId) { window.location.hash = newId; window.location.reload(); }
            };

            let statusBadge;
            if (globalInitError || syncError) { statusBadge = <span className="text-rose-500 flex items-center gap-1 cursor-pointer hover:underline font-bold" onClick={() => setIsSettingsOpen(true)}><AlertCircle className="w-4 h-4" /> 接続エラー (オフライン)</span>; } 
            else if (user) { statusBadge = <span className="text-emerald-600 flex items-center gap-1 font-bold"><Wifi className="w-4 h-4" /> オンライン</span>; } 
            else if (firebaseConfig) { statusBadge = <span className="text-amber-500 flex items-center gap-1 font-bold"><Clock className="w-4 h-4 animate-pulse" /> 接続中...</span>; } 
            else { statusBadge = <span className="text-slate-400 flex items-center gap-1 font-bold"><HardDrive className="w-4 h-4" /> オフライン</span>; }

            // ローディング画面
            if (isLoading) {
                return (
                    <div className="flex flex-col items-center justify-center min-h-screen bg-slate-50 text-slate-500">
                        <Loader2 className="w-10 h-10 animate-spin mb-4 text-indigo-500" />
                        <p className="text-lg font-bold">データを読み込み中...</p>
                        <p className="text-sm mt-2">クラウド同期を確認しています</p>
                    </div>
                );
            }

            return (
                <div className="max-w-[1400px] mx-auto p-4 md:p-6 print:p-0 print:w-full">
                    <div className="mb-6 flex flex-col gap-4 print:hidden">
                        <div className="flex flex-col md:flex-row justify-between items-end gap-4">
                            <div>
                                <h1 className="text-2xl font-bold text-slate-800 flex items-center gap-3"><span className="bg-indigo-600 text-white p-2 rounded-lg"><FileText className="w-5 h-5" /></span>動画制作マネージャー</h1>
                                <div className="flex items-center gap-2 mt-2 ml-1 text-sm">{statusBadge}<div className="flex items-center gap-1 ml-4 bg-slate-100 px-2 py-1 rounded text-slate-500 hover:bg-slate-200 transition-colors cursor-pointer group" onClick={handleChangeId} title="クリックしてIDを変更"><span className="text-xs font-mono">ID: {projectId}</span><Edit3 className="w-3 h-3 opacity-0 group-hover:opacity-100" /></div>{(globalInitError || syncError) && (<span className="text-xs text-rose-400 ml-2 cursor-pointer hover:underline" onClick={() => setIsSettingsOpen(true)}>※クリックして詳細を確認</span>)}</div>
                            </div>
                            <div className="flex gap-2">
                                <div className="flex bg-white rounded-lg border border-slate-200 p-1 shadow-sm"><button onClick={handleUndo} disabled={historyIndex === 0} className="p-2 rounded hover:bg-slate-100 disabled:opacity-30 text-slate-600"><Undo className="w-4 h-4" /></button><button onClick={handleRedo} disabled={historyIndex === history.length - 1} className="p-2 rounded hover:bg-slate-100 disabled:opacity-30 text-slate-600"><Redo className="w-4 h-4" /></button></div>
                                <button onClick={handleCopyLink} className="flex items-center gap-2 px-5 py-2 text-sm font-semibold text-slate-700 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 shadow-md transition-all"><LinkIcon className="w-4 h-4" /> 共有</button>
                                <button onClick={() => window.print()} className="flex items-center gap-2 px-5 py-2 text-sm font-semibold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 shadow-md transition-all"><Printer className="w-4 h-4" /> 印刷 / PDF</button>
                                <button onClick={() => setIsSettingsOpen(true)} className="flex items-center gap-2 px-3 py-2 text-slate-500 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 hover:text-slate-700 shadow-sm transition-all" title="設定"><Settings className="w-5 h-5" /></button>
                            </div>
                        </div>

                        <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-wrap gap-4 items-center">
                            <div className="flex flex-col gap-1 flex-1 min-w-[200px]"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider flex items-center gap-1"><Briefcase className="w-3 h-3" />クライアント名</label><input className="font-bold text-lg text-slate-800 bg-slate-50 border-b-2 border-slate-200 focus:border-indigo-500 focus:bg-white px-2 py-1 w-full outline-none" value={currentData.common.clientName} onChange={(e) => updateCommon('clientName', e.target.value)} /></div>
                            <div className="flex flex-col gap-1 flex-1 min-w-[200px]"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider flex items-center gap-1"><MonitorPlay className="w-3 h-3" />プロジェクト名</label><input className="font-bold text-lg text-slate-800 bg-slate-50 border-b-2 border-slate-200 focus:border-indigo-500 focus:bg-white px-2 py-1 w-full outline-none" value={currentData.common.projectName} onChange={(e) => updateCommon('projectName', e.target.value)} /></div>
                            <div className="flex flex-col gap-1 min-w-[150px]"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider flex items-center gap-1"><CalendarIcon className="w-3 h-3" />撮影日</label><input type="date" className="font-bold text-lg text-slate-800 bg-slate-50 border-b-2 border-slate-200 focus:border-indigo-500 focus:bg-white px-2 py-1 w-full outline-none cursor-pointer" value={currentData.common.date} onChange={(e) => updateCommon('date', e.target.value)} /></div>
                        </div>

                        <div className="flex gap-1 border-b border-slate-200 overflow-x-auto">
                            {['patternA', 'patternB', 'patternC'].map((tab) => (<button key={tab} onClick={() => setActiveTab(tab)} className={`px-8 py-3 text-lg font-black rounded-t-xl transition-all border-t border-x ${activeTab === tab ? 'bg-white text-indigo-600 border-slate-200 border-b-white translate-y-[1px] shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]' : 'bg-slate-100 text-slate-400 border-transparent hover:bg-slate-200 hover:text-slate-600'}`}>{tab === 'patternA' ? 'A' : tab === 'patternB' ? 'B' : 'C'}</button>))}
                            <div className="w-8 border-b border-slate-200"></div>
                            <button onClick={() => setActiveTab('callSheet')} className={`flex items-center gap-2 px-6 py-3 text-sm font-bold rounded-t-xl transition-all border-t border-x ${activeTab === 'callSheet' ? 'bg-white text-emerald-600 border-slate-200 border-b-white translate-y-[1px] shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]' : 'bg-slate-100 text-slate-400 border-transparent hover:bg-slate-200 hover:text-slate-600'}`}><CalendarIcon className="w-4 h-4" /> 香盤表</button>
                            <div className="w-2 border-b border-slate-200"></div>
                            <button onClick={() => setActiveTab('interview')} className={`flex items-center gap-2 px-6 py-3 text-sm font-bold rounded-t-xl transition-all border-t border-x ${activeTab === 'interview' ? 'bg-white text-indigo-600 border-slate-200 border-b-white translate-y-[1px] shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]' : 'bg-slate-100 text-slate-400 border-transparent hover:bg-slate-200 hover:text-slate-600'}`}><Mic className="w-4 h-4" /> インタビュー</button>
                        </div>
                    </div>

                    <div className="bg-white rounded-xl shadow-lg border border-slate-200 overflow-x-auto print:shadow-none print:border-none print:w-full print:max-w-none print:rounded-none min-h-[800px]">
                        {activeTab.startsWith('pattern') ? (<StoryboardEditor data={currentData[activeTab]} common={currentData.common} onUpdate={(d) => updateTabData(activeTab, d)} />) : activeTab === 'interview' ? (<InterviewListEditor data={currentData.interview} onUpdate={(d) => updateTabData('interview', d)} />) : (<CallSheetEditor data={currentData.callSheet} common={currentData.common} onUpdate={(d) => updateTabData('callSheet', d)} />)}
                    </div>
                    <div className="mt-8 text-center text-slate-400 text-sm print:hidden pb-12"><p>動画制作マネージャー v49.0 (Firebase Sync Enabled)</p></div>
                    <SettingsModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} initialError={globalInitError || syncError} />
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<StoryboardApp />);
    </script>
</body>
</html>