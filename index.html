<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>動画制作マネージャー</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import Map for React, Lucide, and Firebase -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
    
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @media print {
            @page { size: landscape; margin: 5mm; }
            body { background: white; -webkit-print-color-adjust: exact; }
            .print\:hidden { display: none !important; }
            .print\:shadow-none { box-shadow: none !important; }
            .print\:border-none { border: none !important; }
            .print\:w-full { width: 100% !important; max-width: none !important; }
            .print\:rounded-none { border-radius: 0 !important; }
            .overflow-x-auto { overflow: visible !important; }
            textarea, input {
                border: none !important;
                resize: none !important;
                background: transparent !important;
                box-shadow: none !important;
            }
            textarea::placeholder { color: transparent; }
            input[type="date"] { border-bottom: none !important; }
        }
        
        /* Date Picker Customization */
        input[type="date"] { position: relative; }
        input[type="date"]::-webkit-calendar-picker-indicator {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; cursor: pointer; padding: 0; margin: 0;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { height: 8px; width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-700 font-sans">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useRef, useLayoutEffect, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Printer, FileText, Edit3, Image as ImageIcon, Clock, PenTool, Video, PlayCircle, Undo, Redo, Calendar as CalendarIcon, Users, MapPin, Briefcase, ChevronDown, MonitorPlay, Wifi, WifiOff, HardDrive, Settings, X, Save, Trash2, AlertCircle, Code, List, HelpCircle, RefreshCw, Link as LinkIcon, Check, ExternalLink } from 'lucide-react';
        
        // Firebase Imports
        import { initializeApp, getApps } from "firebase/app";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "firebase/auth";
        import { getFirestore, doc, setDoc, onSnapshot, collection, initializeFirestore } from "firebase/firestore";

        // --- Firebase Initialization Logic ---
        let app, auth, db;
        const appId = 'storyboard-project-v1'; 
        let globalInitError = null;

        // デフォルト設定
        const defaultFirebaseConfig = {
            apiKey: "AIzaSyDnJf6vHEpdkjhjtnkLxzJaT4EGJgAw1lI",
            authDomain: "ekonte-a4b51.firebaseapp.com",
            projectId: "ekonte-a4b51",
            storageBucket: "ekonte-a4b51.firebasestorage.app",
            messagingSenderId: "402726001930",
            appId: "1:402726001930:web:65f70eb92369726c5ceef3"
        };

        // 1. 設定の決定 
        const savedConfigStr = localStorage.getItem('firebase_config');
        let firebaseConfig = defaultFirebaseConfig; 

        if (savedConfigStr) {
            try {
                const parsed = JSON.parse(savedConfigStr);
                if (parsed && parsed.apiKey && parsed.projectId) {
                    firebaseConfig = parsed;
                } else {
                    console.warn("Saved config is invalid, using default.");
                    localStorage.removeItem('firebase_config');
                }
            } catch (e) {
                console.error("Failed to parse saved firebase config", e);
            }
        }

        // 2. Initialize Firebase
        if (firebaseConfig) {
            try {
                if (!getApps().length) {
                    app = initializeApp(firebaseConfig);
                } else {
                    app = getApps()[0];
                }
                auth = getAuth(app);
                // Firestore初期化時に設定を追加（もし必要なら）
                db = getFirestore(app);
                console.log("Firebase initialized successfully with:", firebaseConfig.projectId);
            } catch (e) {
                console.error("Firebase Init Error:", e);
                globalInitError = e.message;
                app = null; auth = null; db = null;
            }
        }

        // URLパラメータまたはハッシュからプロジェクトIDを取得
        const getProjectIdFromUrl = () => {
            const hash = window.location.hash.substring(1); 
            if (hash) return decodeURIComponent(hash);
            
            const params = new URLSearchParams(window.location.search);
            if (params.get('id')) return params.get('id');

            return 'demo';
        };

        // --- Data Templates ---
        const patternA_Data = {
            type: 'storyboard',
            header: { title: "『入院することになって…』(A案)", page: "1 / 1" },
            cuts: [
                { id: "CUT1-1", title: "来店", camera: "固定（三脚）", visuals: "画①〈固定〉：店舗入口と店内全体\n画②〈固定〉：スタッフが立ち上がる", image: null, seconds: "", dialogue: [{ speaker: "スタッフ", text: "「いらっしゃいませ。今日はどうされましたか？」" }], notes: "押さえる画：店舗入口と店内全体、スタッフが立ち上がる", feedback: "" },
                { id: "CUT1-2", title: "カウンターへ移動・着席", camera: "ジンバル", visuals: "画③〈ジンバル〉：お客様後ろからカウンター方向へ移動\n画④〈ジンバル〉：着席する動きまで追う\n画⑤〈ジンバル〉：向かい合った位置で止める", image: null, seconds: "", dialogue: [{ speaker: "お客様", text: "「実は今度入院することになったんですが…\n\n保険金の請求のことがよくわからなくて」" }, { speaker: "スタッフ", text: "「そうでしたか」" }], notes: "", feedback: "" },
                { id: "CUT2", title: "受け止め", camera: "固定（三脚）", visuals: "画①〈固定〉：スタッフ正面・上半身\n画②〈固定〉：スタッフ表情寄り\n画③〈固定〉：お客様の手元", image: null, seconds: "", dialogue: [{ speaker: "スタッフ", text: "「それはご不安ですよね。\n\n私たちがしっかりお手伝いしますので、ご安心ください」" }, { speaker: "お客様", text: "「ありがとうございます」" }], notes: "", feedback: "" },
                { id: "CUT3", title: "カルテ確認", camera: "固定（三脚）", visuals: "画①〈固定〉：ノートPCと操作する手元\n画②〈固定〉：肩越しでPCを見るスタッフ\n画③〈固定〉：画面を見てうなずくスタッフ", image: null, seconds: "", dialogue: [{ speaker: "スタッフ", text: "「ご入院はいつからのご予定ですか？」" }, { speaker: "お客様", text: "「来週の火曜日からです。膝の手術で」" }, { speaker: "スタッフ", text: "「そうなんですね」" }], notes: "", feedback: "" },
                { id: "CUT4", title: "過去の記録", camera: "固定（三脚）", visuals: "画①〈固定〉：スタッフ斜め前・上半身\n画②〈固定〉：カルテ画面（文字は映らない）\n画③〈固定〉：お客様の手元", image: null, seconds: "", dialogue: [{ speaker: "スタッフ", text: "「10年前にこの保険にご加入いただいた時も、\n\nお子様に迷惑をかけたくないと記録があります」" }, { speaker: "お客様", text: "「…そうでしたね」" }, { speaker: "スタッフ", text: "「でも、私たちのことは頼ってくださいね」" }, { speaker: "お客様", text: "「はい」" }], notes: "", feedback: "" },
                { id: "CUT5", title: "手続き説明", camera: "固定（三脚）", visuals: "画①〈固定〉：テーブル俯瞰で書類を並べる\n画②〈固定〉：指差しアップ\n画③〈固定〉：書類をそろえる手元", image: null, seconds: "", dialogue: [{ speaker: "スタッフ", text: "「それでは給付金のご請求方法をご案内しますね。\n\nまず病院から診断書をもらっていただいて…」" }, { speaker: "お客様", text: "「なるほど」" }], notes: "", feedback: "" },
                { id: "CUT6", title: "記入例を渡す", camera: "固定（三脚)", visuals: "画①〈固定〉：記入例アップ\n画②〈固定〉：お客様側から見た書類", image: null, seconds: "", dialogue: [{ speaker: "スタッフ", text: "「わかりにくい所もあるので、\n\nご記入例もお渡ししますね」" }, { speaker: "お客様", text: "「助かります」" }], notes: "", feedback: "" },
                { id: "CUT7", title: "家族への共有提案", camera: "固定（三脚）", visuals: "画①〈固定〉：書類が2部並んでいる状態\n画②〈固定〉：きちんとファイル2冊\n画③〈固定〉：お客様の手が止まる", image: null, seconds: "", dialogue: [{ speaker: "スタッフ", text: "「こちら2部ご用意しましたので、\n\n念のため1部はお子様にお渡しください」" }, { speaker: "お客様", text: "「子どもにですか…」" }, { speaker: "スタッフ", text: "「万一のときに、\n\nどんな保険に入っているかが分かるだけでも、\n\nご家族は安心できると思います」" }, { speaker: "お客様", text: "「…そうですね」" }], notes: "", feedback: "" },
                { id: "CUT8", title: "想いを伝える", camera: "固定（三脚)", visuals: "画①〈固定〉：スタッフ表情\n画②〈固定〉：ファイルに手を置く手元", image: null, seconds: "", dialogue: [{ speaker: "スタッフ", text: "「保険のことを共有しておくと、\n\nいざという時に慌てずに済むと思います」" }, { speaker: "お客様", text: "「確かにそうですね」" }], notes: "", feedback: "" },
                { id: "CUT9", title: "安心の反応", camera: "固定（三脚)", visuals: "画①〈固定〉：ファイルを受け取る手元\n画②〈固定〉：少し間を置いた静止カット", image: null, seconds: "", dialogue: [{ speaker: "お客様", text: "「相談したら、なんだかホッとしました」" }], notes: "", feedback: "" },
                { id: "CUT10", title: "見送り・退店後", camera: "ジンバル", visuals: "画①〈ジンバル〉：お客様後ろ姿で出口へ\n画②〈ジンバル〉：スタッフが席に戻る\n画③〈ジンバル〉：PC（カルテ）を閉じる\n画④〈ジンバル〉：店舗ロゴまたは外観", image: null, seconds: "", dialogue: [{ speaker: "スタッフ", text: "「どうかお身体を大切に。\n\n一日も早いご回復をお祈りしています」" }, { speaker: "お客様", text: "「ありがとうございます」" }], notes: "", feedback: "" }
            ]
        };

        const patternB_Data = {
            type: 'storyboard',
            header: { title: "『保険料を下げたい…』(B案)", page: "1 / 1" },
            cuts: [
                { id: "CUT1-1", title: "来店", camera: "固定（三脚）", visuals: "画①〈固定〉：店舗入口と店内全体\n画②〈固定〉：スタッフが立ち上がる", image: null, seconds: "", dialogue: [{ speaker: "お客様", text: "「初めてなんですが、相談できますか？」" }, { speaker: "スタッフ", text: "「いらっしゃいませ。今日はどうされましたか？」" }], notes: "", feedback: "" },
                { id: "CUT1-2", title: "着席", camera: "ジンバル", visuals: "画③〈ジンバル〉：後ろ姿でカウンターへ\n画④〈ジンバル〉：着席まで\n画⑤〈ジンバル〉：向かい合った位置で止める", image: null, seconds: "", dialogue: [{ speaker: "お客様", text: "「毎月の保険料を下げたくて、\n保険を解約しようかと思っているんですが…\nどれを解約していいのかわからなくて」" }, { speaker: "スタッフ", text: "「そうなんですね」" }], notes: "", feedback: "" },
                { id: "CUT2", title: "担当者の確認", camera: "固定（三脚）", visuals: "画①〈固定〉：スタッフ正面\n画②〈固定〉：お客様手元", image: null, seconds: "", dialogue: [{ speaker: "スタッフ", text: "「そのことは、ご担当の方には相談されましたか？」" }, { speaker: "お客様", text: "「いえ。担当の方は辞めてしまって」" }], notes: "", feedback: "" },
                { id: "CUT3", title: "理解度の確認", camera: "固定（三脚）", visuals: "画①〈固定〉：スタッフ斜め前\n画②〈固定〉：PC操作の手元", image: null, seconds: "", dialogue: [{ speaker: "スタッフ", text: "「ご加入からかなり経ちますが、\n内容は覚えていらっしゃいますか？」" }, { speaker: "お客様", text: "「正直、よくわからないです」" }], notes: "", feedback: "" },
                { id: "CUT4", title: "理由の深掘り", camera: "固定（三脚）", visuals: "画①〈固定〉：スタッフ\n画②〈固定〉：お客様", image: null, seconds: "", dialogue: [{ speaker: "スタッフ", text: "「今回、なぜ保険料を下げたいと思われたんですか？」" }, { speaker: "お客様", text: "「最近、将来のこととか老後のこととか考えるようになって。\nもっと貯金しないといけないなと思って」" }, { speaker: "スタッフ", text: "「なるほど」" }], notes: "", feedback: "" },
                { id: "CUT5", title: "加入目的の確認", camera: "固定（三脚）", visuals: "画①〈固定〉：スタッフ\n画②〈固定〉：お客様手元", image: null, seconds: "", dialogue: [{ speaker: "スタッフ", text: "「念のためですが、\nこの保険はどんな目的で加入されたんですか？」" }, { speaker: "お客様", text: "「子どもが生まれたので、\n自分に万一のことがあった時、\n家族が困らないようにと思ってです」" }], notes: "", feedback: "" },
                { id: "CUT6", title: "気づき", camera: "固定（三脚）", visuals: "画①〈固定〉：スタッフ表情\n画②〈固定〉：お客様", image: null, seconds: "", dialogue: [{ speaker: "スタッフ", text: "「その状況に、今も大きな変化はありますか？」" }, { speaker: "お客様", text: "「いえ。子どももまだ中学生なので…\nもしかしたら、今こそ必要なのかもしれません」" }], notes: "", feedback: "" },
                { id: "CUT7", title: "見直し提案", camera: "固定（三脚）", visuals: "画①〈固定〉：PC画面（内容は見せない）\n画②〈固定〉：スタッフ手元", image: null, seconds: "", dialogue: [{ speaker: "スタッフ", text: "「解約の前に、\n一度きちんと内容を確認してみましょう」" }, { speaker: "お客様", text: "「お願いします」" }], notes: "", feedback: "" },
                { id: "CUT8", title: "記録の説明", camera: "固定（三脚）", visuals: "画①〈固定〉：PC入力\n画②〈固定〉：スタッフ", image: null, seconds: "", dialogue: [{ speaker: "スタッフ", text: "「今日のお話も記録しておきますので、\n次は別のスタッフでも対応できます」" }, { speaker: "お客様", text: "「それは安心ですね」" }], notes: "", feedback: "" },
                { id: "CUT9", title: "締め", camera: "ジンバル", visuals: "画①〈ジンバル〉：席を立つ\n画②〈ジンバル〉：店内引き\n画③〈ジンバル〉：店舗外観", image: null, seconds: "", dialogue: [{ speaker: "お客様", text: "「困った時に相談できる場所ができて、安心しました」" }, { speaker: "スタッフ", text: "「いつでもご相談ください」" }], notes: "", feedback: "" }
            ]
        };

        const patternC_Data = {
            type: 'storyboard',
            header: { title: "『お伝えしたいことがあります』(C案)", page: "1 / 1" },
            cuts: [
                { id: "CUT1", title: "電話", camera: "固定（三脚）", visuals: "画①〈固定〉：電話をかける手元\n画②〈固定〉：受話器を置く", image: null, seconds: "", dialogue: [{ speaker: "スタッフ", text: "「保険ほっとラインです。\n学資保険の満期まで2ヶ月となりましたので、\n満期金の受け取りや税金についてお伝えしたくて\nご連絡しました」" }, { speaker: "お客様", text: "「それでは週末に伺います」" }], notes: "", feedback: "" },
                { id: "CUT2", title: "来店", camera: "固定（三脚）", visuals: "画①〈固定〉：店内全体\n画②〈固定〉：着席", image: null, seconds: "", dialogue: [{ speaker: "スタッフ", text: "「本日はご来店ありがとうございます」" }, { speaker: "お客様", text: "「わざわざ電話をいただいて、ありがとうございます」" }], notes: "", feedback: "" },
                { id: "CUT3", title: "加入当時の目的", camera: "固定（三脚）", visuals: "画①〈固定〉：カルテを見る\n画②〈固定〉：スタッフ表情", image: null, seconds: "", dialogue: [{ speaker: "スタッフ", text: "「この保険にご加入されたのは、もう10年以上前ですね。\n“この子の夢を応援したい”と記録が残っています」" }, { speaker: "お客様", text: "「ああ、そんなこと言ってましたか」" }], notes: "", feedback: "" },
                { id: "CUT4", title: "現在の状況", camera: "固定（三脚）", visuals: "画①〈固定〉：スタッフ\n画②〈固定〉：お客様手元", image: null, seconds: "", dialogue: [{ speaker: "スタッフ", text: "「春から大学生ですね」" }, { speaker: "お客様", text: "「はい。あっという間に大きくなって」" }], notes: "", feedback: "" },
                { id: "CUT5", title: "不安の言語化", camera: "固定（三脚）", visuals: "画①〈固定〉：お客様\n画②〈固定〉：スタッフ", image: null, seconds: "", dialogue: [{ speaker: "お客様", text: "「子どもが大きくなってきて、\n今の保険のままでいいのか、\n少し不安になっていて」" }, { speaker: "スタッフ", text: "「そうですよね」" }], notes: "", feedback: "" },
                { id: "CUT6", title: "定期点検の提案", camera: "固定（三脚）", visuals: "画①〈固定〉：資料を広げる\n画②〈固定〉：ファイル", image: null, seconds: "", dialogue: [{ speaker: "スタッフ", text: "「それでは、定期点検という形で、\n今の補償内容と、\nこれから必要な保障を一緒に確認しましょう」" }, { speaker: "お客様", text: "「ぜひお願いします」" }], notes: "", feedback: "" },
                { id: "CUT7", title: "きちんとファイル更新", camera: "固定（三脚）", visuals: "画①〈固定〉：ファイル差し替え\n画②〈固定〉：書類を揃える", image: null, seconds: "", dialogue: [{ speaker: "スタッフ", text: "「きちんとファイルも、\n最新の内容に更新してお渡しします」" }, { speaker: "お客様", text: "「ありがとうございます」" }], notes: "", feedback: "" },
                { id: "CUT8", title: "締め", camera: "ジンバル", visuals: "画①〈ジンバル〉：立ち上がる\n画②〈ジンバル〉：店内引き\n画③〈ジンバル〉：店舗外観", image: null, seconds: "", dialogue: [{ speaker: "スタッフ", text: "「これからも、\nご家族の安心を見守っていければと思います」" }, { speaker: "お客様", text: "「ずっと家族を見てくれている感じがして、安心します」" }], notes: "", feedback: "" }
            ]
        };

        const initialCallSheet = {
            type: 'callsheet',
            header: { title: "撮影香盤表", location: "〇〇保険ショップ 新宿店", collection: "08:00 現地集合" },
            rows: [
                { time: "09:00～10:00", scene: "-", location: "全体", action: "設営・準備", cast: "スタッフ全員", notes: "機材搬入含む" },
                { time: "10:00～12:00", scene: "午前", location: "インタビューエリア", action: "インタビュー撮影\n(人事担当者：説明多め → 社員3名：サクサク進行)", cast: "人事担当者、社員3名", notes: "午前中に完了させる" },
                { time: "12:00～13:00", scene: "-", location: "休憩室 / スタジオ", action: "昼休憩・セットチェンジ", cast: "全スタッフ", notes: "会議机を接客カウンター風に配置換え" },
                { time: "13:00～16:30", scene: "午後", location: "カウンターセット", action: "ドラマパート撮影\n(3パターン撮影)", cast: "店員役、お客様役", notes: "A/B/C案 順次撮影" },
                { time: "16:30～17:00", scene: "ブツ撮り", location: "エントランス他", action: "インサート撮影\n(カルテ、ファイル、オフィスエントランス)", cast: "-", notes: "自然光の状況確認" },
                { time: "17:30～18:30", scene: "-", location: "-", action: "完全撤収", cast: "全スタッフ", notes: "原状回復確認" },
            ]
        };

        const initialProjectData = {
            common: { clientName: "株式会社〇〇", projectName: "2026年 採用動画制作", date: "2026-01-11" },
            patternA: patternA_Data,
            patternB: patternB_Data,
            patternC: patternC_Data,
            callSheet: initialCallSheet
        };

        // --- Components ---

        const AutoResizeTextarea = ({ value, onChange, onBlur, className, placeholder, rows = 1, style }) => {
            const textareaRef = useRef(null);
            useLayoutEffect(() => {
                if (textareaRef.current) {
                    textareaRef.current.style.height = "auto";
                    textareaRef.current.style.height = `${textareaRef.current.scrollHeight}px`;
                }
            }, [value]);
            return <textarea ref={textareaRef} className={`${className} overflow-hidden`} value={value} onChange={onChange} onBlur={onBlur} placeholder={placeholder} rows={rows} style={style} />;
        };

        // Settings Modal Component
        function SettingsModal({ isOpen, onClose, initialError }) {
            const [mode, setMode] = useState('simple'); 
            const [apiKey, setApiKey] = useState('');
            const [authDomain, setAuthDomain] = useState('');
            const [projectId, setProjectId] = useState('');
            const [configJson, setConfigJson] = useState('');
            const [error, setError] = useState(initialError);

            useEffect(() => {
                if (isOpen) {
                    setError(initialError); 
                    const saved = localStorage.getItem('firebase_config');
                    if (saved) {
                        try {
                            const parsed = JSON.parse(saved);
                            setApiKey(parsed.apiKey || '');
                            setAuthDomain(parsed.authDomain || '');
                            setProjectId(parsed.projectId || '');
                            setConfigJson(JSON.stringify(parsed, null, 2));
                        } catch(e) {
                            setConfigJson(saved || '');
                        }
                    } else if (defaultFirebaseConfig) {
                        setApiKey(defaultFirebaseConfig.apiKey || '');
                        setAuthDomain(defaultFirebaseConfig.authDomain || '');
                        setProjectId(defaultFirebaseConfig.projectId || '');
                        setConfigJson(JSON.stringify(defaultFirebaseConfig, null, 2));
                    }
                }
            }, [isOpen, initialError]);

            const handleSave = () => {
                let config = null;
                try {
                    if (mode === 'simple') {
                        if (!apiKey.trim() || !authDomain.trim() && !projectId.trim()) {
                             localStorage.removeItem('firebase_config');
                             window.location.reload();
                             return;
                        }
                        if (!apiKey.trim() || !authDomain.trim() || !projectId.trim()) {
                            setError("API Key, Auth Domain, Project ID は必須です。");
                            return;
                        }
                        config = { 
                            ...defaultFirebaseConfig, 
                            apiKey: apiKey.trim(), 
                            authDomain: authDomain.trim(), 
                            projectId: projectId.trim() 
                        };
                    } else {
                        if (!configJson.trim()) {
                            localStorage.removeItem('firebase_config');
                            window.location.reload();
                            return;
                        }
                        config = JSON.parse(configJson);
                    }
                    
                    localStorage.setItem('firebase_config', JSON.stringify(config));
                    window.location.reload(); 
                } catch (e) {
                    setError("JSONの形式が正しくありません。");
                }
            };

            const handleResetDefault = () => {
                if(confirm("ブラウザに保存された設定を削除し、コード内のデフォルト設定（ekonte-a4b51）を使用しますか？")) {
                    localStorage.removeItem('firebase_config');
                    window.location.reload();
                }
            };

            const handleDelete = () => {
                if(confirm("設定を完全に削除してオフラインモードにしますか？")) {
                    localStorage.setItem('firebase_config', '{}');
                    window.location.reload();
                }
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-md overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                            <h3 className="font-bold text-lg text-slate-800 flex items-center gap-2">
                                <Settings className="w-5 h-5 text-slate-500" />
                                接続設定 (Firebase)
                            </h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600"><X className="w-5 h-5" /></button>
                        </div>
                        <div className="p-6 overflow-y-auto">
                            {error && (
                                <div className="mb-4 p-3 bg-rose-50 border border-rose-200 rounded text-rose-600 text-sm flex items-start gap-2">
                                    <AlertCircle className="w-5 h-5 flex-shrink-0" />
                                    <div>
                                        <p className="font-bold">エラーが発生しました</p>
                                        <p className="text-xs break-all">{typeof error === 'string' ? error : JSON.stringify(error)}</p>
                                        {(typeof error === 'string' && (error.includes("auth") || error.includes("configuration") || error.includes("unavailable"))) && (
                                            <div className="mt-2 text-xs text-rose-700 font-bold bg-white p-2 rounded border border-rose-100">
                                                <p class="mb-1">【考えられる原因と対処】</p>
                                                <ul class="list-disc pl-4 space-y-1">
                                                    {error.includes("unavailable") && <li><strong>Firestore Databaseが作成されていません。</strong> Firebase Consoleの[Build] &gt; [Firestore Database]からデータベースを作成してください（モードは「テストモード」を推奨）。</li>}
                                                    {error.includes("auth") && <li><strong>匿名認証が無効です。</strong> Firebase Consoleの[Authentication] &gt; [Sign-in method]で「匿名」を有効にしてください。</li>}
                                                    <li>ネットワーク接続を確認してください。</li>
                                                </ul>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            <div className="flex gap-2 mb-4 border-b border-slate-200 pb-2">
                                <button onClick={() => setMode('simple')} className={`flex items-center gap-1 text-xs font-bold px-3 py-1 rounded-full transition-colors ${mode === 'simple' ? 'bg-indigo-100 text-indigo-700' : 'text-slate-400 hover:bg-slate-100'}`}><List className="w-3 h-3" /> 簡易入力</button>
                                <button onClick={() => setMode('json')} className={`flex items-center gap-1 text-xs font-bold px-3 py-1 rounded-full transition-colors ${mode === 'json' ? 'bg-indigo-100 text-indigo-700' : 'text-slate-400 hover:bg-slate-100'}`}><Code className="w-3 h-3" /> JSON入力</button>
                            </div>

                            {mode === 'simple' ? (
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">API Key</label>
                                        <input type="text" className="w-full text-sm bg-slate-50 border border-slate-300 rounded px-3 py-2 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none" value={apiKey} onChange={(e) => setApiKey(e.target.value)} placeholder="AIzaSy..." />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Auth Domain</label>
                                        <input type="text" className="w-full text-sm bg-slate-50 border border-slate-300 rounded px-3 py-2 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none" value={authDomain} onChange={(e) => setAuthDomain(e.target.value)} placeholder="project-id.firebaseapp.com" />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Project ID</label>
                                        <input type="text" className="w-full text-sm bg-slate-50 border border-slate-300 rounded px-3 py-2 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none" value={projectId} onChange={(e) => setProjectId(e.target.value)} placeholder="project-id" />
                                    </div>
                                </div>
                            ) : (
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Config JSON</label>
                                    <textarea className="w-full h-48 font-mono text-xs bg-slate-50 border border-slate-300 rounded p-3 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none resize-none" value={configJson} onChange={(e) => setConfigJson(e.target.value)} placeholder={'{\n  "apiKey": "...",\n  "authDomain": "...",\n  ...\n}'} />
                                </div>
                            )}
                            
                            <div className="mt-6 flex flex-col gap-2">
                                <button onClick={handleResetDefault} className="flex items-center justify-center gap-2 px-4 py-2 text-xs font-semibold text-emerald-600 bg-emerald-50 hover:bg-emerald-100 rounded border border-emerald-200 transition-colors w-full">
                                    <RefreshCw className="w-3 h-3" /> デフォルト設定(ekonte-a4b51)に戻す
                                </button>
                                <a href="https://console.firebase.google.com/u/0/project/ekonte-a4b51/authentication/providers" target="_blank" rel="noreferrer" className="flex items-center justify-center gap-2 px-4 py-2 text-xs font-semibold text-blue-600 bg-blue-50 hover:bg-blue-100 rounded border border-blue-200 transition-colors w-full">
                                    <ExternalLink className="w-3 h-3" /> Firebaseコンソールを開く
                                </a>
                            </div>
                        </div>
                        <div className="p-4 border-t border-slate-200 bg-slate-50 flex justify-between">
                            <button onClick={handleDelete} className="flex items-center gap-2 px-3 py-2 text-xs font-semibold text-slate-400 hover:text-rose-600 hover:bg-rose-50 rounded transition-colors"><Trash2 className="w-3 h-3" /> 設定削除</button>
                            <div className="flex gap-2">
                                <button onClick={onClose} className="px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-200 rounded transition-colors">キャンセル</button>
                                <button onClick={handleSave} className="flex items-center gap-2 px-6 py-2 text-sm font-semibold text-white bg-indigo-600 hover:bg-indigo-700 rounded shadow transition-colors"><Save className="w-4 h-4" /> 保存</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Storyboard Editor (省略なし)
        function StoryboardEditor({ data, common, onUpdate }) {
            const fileInputRefs = useRef([]);
            const handleCutUpdate = (index, field, value) => { const newCuts = [...data.cuts]; newCuts[index] = { ...newCuts[index], [field]: value }; onUpdate({ ...data, cuts: newCuts }); };
            const handleDialogueUpdate = (cutIndex, dIndex, field, value) => { const newCuts = [...data.cuts]; const newDialogue = [...newCuts[cutIndex].dialogue]; newDialogue[dIndex] = { ...newDialogue[dIndex], [field]: value }; newCuts[cutIndex] = { ...newCuts[cutIndex], dialogue: newDialogue }; onUpdate({ ...data, cuts: newCuts }); };
            const handleImageSelect = (index, e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (event) => handleCutUpdate(index, 'image', event.target.result); reader.readAsDataURL(file); } };
            const handlePaste = (index, e) => { const items = e.clipboardData.items; for (let i = 0; i < items.length; i++) { if (items[i].type.indexOf('image') !== -1) { const blob = items[i].getAsFile(); const reader = new FileReader(); reader.onload = (event) => handleCutUpdate(index, 'image', event.target.result); reader.readAsDataURL(blob); e.preventDefault(); return; } } };
            const calculateEstimatedTime = (dialogue) => { const totalChars = dialogue.reduce((acc, line) => acc + line.text.replace(/[\s\u3000「」]/g, '').length, 0); return Math.max(1, Math.ceil(totalChars / 4)); };
            let cumulativeTime = 0;

            return (
                <div className="min-w-[900px]">
                    <div className="p-8 md:p-10 border-b border-slate-100 print:p-6 print:border-slate-800 bg-white">
                        <div className="mb-2 text-center">
                            <div className="text-sm font-bold text-slate-500 mb-2">{common.clientName} 御中</div>
                            <div className="text-xs font-bold text-slate-400 mb-1 tracking-wide">{common.projectName}</div>
                            <div className="text-3xl font-extrabold text-slate-900 tracking-tight text-center w-full">動画制作 絵コンテ</div>
                        </div>
                        <div className="flex justify-center flex-wrap gap-6 md:gap-12 text-sm text-slate-500 mt-6">
                            <div className="group flex flex-col items-start gap-1">
                                <span className="text-[10px] font-bold uppercase tracking-wider text-slate-400">案件名 / タイトル</span>
                                <input className="font-bold text-lg text-slate-900 bg-slate-50 border border-transparent hover:border-slate-200 focus:bg-white focus:border-indigo-500 rounded px-3 py-1 w-96 text-center" value={data.header.title} onChange={(e) => onUpdate({ ...data, header: { ...data.header, title: e.target.value } })} />
                            </div>
                            <div className="group flex flex-col items-start gap-1">
                                <span className="text-[10px] font-bold uppercase tracking-wider text-slate-400">撮影日</span>
                                <div className="font-medium text-lg text-slate-900 px-3 py-1 border-b border-slate-200 min-w-[120px] text-center">{common.date}</div>
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-[50px_3fr_3fr_3fr_70px_2fr] bg-slate-50 border-b border-slate-200 text-[11px] font-bold text-slate-500 uppercase tracking-widest print:bg-slate-100 print:border-slate-800 print:text-black">
                        <div className="p-3 text-center border-r border-slate-200 print:border-slate-400">No.</div>
                        <div className="p-3 text-center border-r border-slate-200 print:border-slate-400">画面 (イメージ)</div>
                        <div className="p-3 text-center border-r border-slate-200 print:border-slate-400">演出・カメラ</div>
                        <div className="p-3 text-center border-r border-slate-200 print:border-slate-400">セリフ</div>
                        <div className="p-3 text-center border-r border-slate-200 print:border-slate-400">時間</div>
                        <div className="p-3 text-center">備考・修正</div>
                    </div>

                    {data.cuts.map((cut, index) => {
                        const estimatedTime = calculateEstimatedTime(cut.dialogue);
                        const duration = cut.seconds !== "" ? parseInt(cut.seconds) : estimatedTime;
                        cumulativeTime += duration;
                        const displayTime = cut.seconds !== "" ? cut.seconds : estimatedTime;

                        return (
                            <div key={cut.id} className="grid grid-cols-[50px_3fr_3fr_3fr_70px_2fr] border-b border-slate-100 last:border-none hover:bg-slate-50/50 transition-colors group break-inside-avoid print:border-slate-300">
                                <div className="p-4 border-r border-slate-100 flex flex-col items-center justify-center bg-slate-50/30 print:bg-white print:border-slate-400">
                                    <span className="text-sm font-black text-slate-800 font-mono tracking-tighter">{cut.id}</span>
                                </div>
                                <div className="p-4 border-r border-slate-100 flex flex-col justify-start print:border-slate-400">
                                    <div className="mb-2 w-full">
                                        <AutoResizeTextarea className="w-full text-sm font-bold text-slate-800 bg-transparent border-b border-transparent hover:border-slate-200 focus:border-indigo-500 focus:ring-0 px-1 py-0.5 resize-none leading-tight placeholder-slate-300" value={cut.title} onChange={(e) => handleCutUpdate(index, 'title', e.target.value)} onBlur={() => {}} rows={1} placeholder="シーン名 / 役割" />
                                    </div>
                                    <div className="aspect-video w-full bg-slate-50 border-2 border-dashed border-slate-200 rounded-lg flex items-center justify-center text-slate-300 overflow-hidden relative cursor-pointer hover:border-indigo-400 hover:bg-indigo-50/10 transition-all group/image print:border-slate-800 print:bg-white print:rounded-none" onClick={() => fileInputRefs.current[index]?.click()} onPaste={(e) => handlePaste(index, e)} tabIndex={0}>
                                        {cut.image ? (
                                            <img src={cut.image} alt="Storyboard" className="w-full h-full object-contain" />
                                        ) : (
                                            <div className="flex flex-col items-center text-center p-2 transform group-hover/image:scale-105 transition-transform duration-300">
                                                <ImageIcon className="w-8 h-8 mb-2 text-slate-200 group-hover/image:text-indigo-300" />
                                                <span className="text-[10px] font-medium text-slate-400 print:hidden">画像を選択<br/>(クリック/貼付)</span>
                                            </div>
                                        )}
                                        <input type="file" accept="image/*" className="hidden" ref={el => fileInputRefs.current[index] = el} onChange={(e) => handleImageSelect(index, e)} />
                                    </div>
                                </div>
                                <div className="p-4 border-r border-slate-100 flex flex-col justify-center gap-4 print:border-slate-400">
                                    <div className="relative">
                                        <div className="flex items-center gap-1.5 mb-1.5">
                                            <span className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">演出指示</span>
                                        </div>
                                        <AutoResizeTextarea className="w-full text-sm leading-relaxed bg-slate-50 border-none rounded-md px-3 py-2 focus:bg-white focus:ring-2 focus:ring-indigo-100 transition-all placeholder-slate-300 print:bg-transparent print:p-0" value={cut.visuals} onChange={(e) => handleCutUpdate(index, 'visuals', e.target.value)} onBlur={() => {}} rows={4} />
                                    </div>
                                    <div className="relative pt-3 border-t border-slate-100 border-dashed print:border-slate-300">
                                        <div className="flex items-center gap-1.5 mb-1.5">
                                            <span className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">カメラワーク</span>
                                        </div>
                                        <AutoResizeTextarea className="w-full text-sm font-medium text-slate-700 bg-slate-50 border-none rounded-md px-3 py-2 focus:bg-white focus:ring-2 focus:ring-emerald-100 transition-all placeholder-slate-300 print:bg-transparent print:p-0" value={cut.camera} onChange={(e) => handleCutUpdate(index, 'camera', e.target.value)} onBlur={() => {}} rows={2} />
                                    </div>
                                </div>
                                <div className="p-4 border-r border-slate-100 flex flex-col justify-center print:border-slate-400">
                                    <div className="space-y-4">
                                        {cut.dialogue.map((line, dIndex) => (
                                            <div key={dIndex} className="flex flex-col gap-1 border-l-2 border-slate-100 pl-3 hover:border-indigo-200 transition-colors print:border-none print:pl-0">
                                                <input className="text-[11px] font-bold text-slate-500 bg-transparent border-none focus:ring-0 p-0 mb-0.5" value={line.speaker} onChange={(e) => handleDialogueUpdate(index, dIndex, 'speaker', e.target.value)} onBlur={() => {}} placeholder="話者" />
                                                <AutoResizeTextarea className="w-full text-sm bg-transparent border-none p-0 focus:ring-0 leading-relaxed text-slate-800" value={line.text} onChange={(e) => handleDialogueUpdate(index, dIndex, 'text', e.target.value)} onBlur={() => {}} rows={1} placeholder="セリフ" />
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div className="p-2 border-r border-slate-100 flex flex-col items-center justify-center bg-slate-50/30 print:bg-white print:border-slate-400">
                                    <div className="flex flex-col items-center mb-3">
                                        <div className="flex items-baseline justify-center gap-1">
                                            <input type="text" className={`w-12 text-center font-bold text-xl bg-transparent border-b-2 focus:ring-0 p-1 transition-colors ${cut.seconds ? 'text-indigo-600 border-indigo-200' : 'text-slate-400 border-transparent hover:border-slate-200 focus:border-indigo-400 focus:text-slate-600'}`} value={displayTime} onChange={(e) => handleCutUpdate(index, 'seconds', e.target.value)} onBlur={() => {}} />
                                            <span className="text-xs font-medium text-slate-400">秒</span>
                                        </div>
                                        <span className="text-[9px] text-slate-400 mt-1 uppercase tracking-wider font-bold">目安</span>
                                    </div>
                                    <div className="flex flex-col items-center pt-2 border-t border-slate-200 w-full">
                                        <div className="flex items-center gap-1 text-slate-600">
                                            <PlayCircle className="w-3 h-3 text-slate-400" />
                                            <span className="text-xs font-mono font-medium">{cumulativeTime}秒</span>
                                        </div>
                                        <span className="text-[9px] text-slate-400 mt-0.5 uppercase tracking-wider font-bold">累計</span>
                                    </div>
                                </div>
                                <div className="p-4 flex flex-col gap-4 bg-yellow-50/20 print:bg-white">
                                    <div className="flex-1">
                                        <label className="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-2 block">備考</label>
                                        <AutoResizeTextarea className="w-full text-xs text-slate-600 bg-transparent border border-slate-200 rounded p-2 focus:bg-white focus:border-yellow-400 focus:ring-1 focus:ring-yellow-200 transition-all print:border-none print:p-0" value={cut.notes} onChange={(e) => handleCutUpdate(index, 'notes', e.target.value)} onBlur={() => {}} rows={3} />
                                    </div>
                                    <div className="flex-1">
                                        <label className="text-[9px] font-bold text-rose-400 uppercase tracking-wider mb-2 block flex items-center gap-1"><PenTool className="w-3 h-3" />赤字修正</label>
                                        <AutoResizeTextarea className="w-full text-xs text-rose-600 font-medium bg-rose-50 border border-rose-100 rounded p-2 focus:bg-white focus:border-rose-400 focus:ring-1 focus:ring-rose-200 transition-all placeholder-rose-200 print:bg-transparent print:border-none print:p-0" value={cut.feedback} onChange={(e) => handleCutUpdate(index, 'feedback', e.target.value)} onBlur={() => {}} rows={3} />
                                    </div>
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        }

        // Call Sheet Editor Component
        function CallSheetEditor({ data, common, onUpdate }) {
            const handleHeaderChange = (field, value) => onUpdate({ ...data, header: { ...data.header, [field]: value } });
            const handleRowChange = (index, field, value) => {
                const newRows = [...data.rows];
                newRows[index] = { ...newRows[index], [field]: value };
                onUpdate({ ...data, rows: newRows });
            };

            return (
                <div className="bg-white min-h-[800px] min-w-[900px]">
                    <div className="p-8 md:p-10 border-b-2 border-slate-800 bg-slate-50 print:bg-white print:p-6 print:border-slate-800">
                        <h2 className="text-3xl font-black text-center mb-8 tracking-tight text-slate-900">撮影香盤表</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mx-auto">
                            <div className="space-y-4">
                                <div className="flex items-center gap-3"><span className="w-24 text-xs font-bold uppercase text-slate-400 tracking-wider">クライアント</span><div className="flex-1 font-bold text-lg border-b border-slate-300 px-1 py-0.5">{common.clientName}</div></div>
                                <div className="flex items-center gap-3"><span className="w-24 text-xs font-bold uppercase text-slate-400 tracking-wider">撮影日</span><div className="flex-1 font-medium border-b border-slate-300 px-1 py-0.5">{common.date}</div></div>
                            </div>
                            <div className="space-y-4">
                                <div className="flex items-center gap-3"><span className="w-24 text-xs font-bold uppercase text-slate-400 tracking-wider">場所 / ロケ地</span><input className="flex-1 font-medium border-b border-slate-300 focus:border-emerald-500 focus:ring-0 bg-transparent" value={data.header.location} onChange={(e) => handleHeaderChange('location', e.target.value)} /></div>
                                <div className="flex items-center gap-3"><span className="w-24 text-xs font-bold uppercase text-slate-400 tracking-wider">集合時間</span><input className="flex-1 font-bold text-lg text-emerald-600 border-b border-slate-300 focus:border-emerald-500 focus:ring-0 bg-transparent" value={data.header.collection} onChange={(e) => handleHeaderChange('collection', e.target.value)} /></div>
                            </div>
                        </div>
                    </div>
                    <div className="w-full">
                        <div className="grid grid-cols-[140px_1fr_1.5fr_2fr_1.5fr_1.5fr] bg-slate-800 text-white text-[10px] font-bold uppercase tracking-widest">
                            <div className="p-3 text-center border-r border-slate-700">時間 (00:00～00:00)</div>
                            <div className="p-3 text-center border-r border-slate-700">シーン</div>
                            <div className="p-3 text-center border-r border-slate-700">場所 / セット</div>
                            <div className="p-3 text-center border-r border-slate-700">アクション / 内容</div>
                            <div className="p-3 text-center border-r border-slate-700">キャスト</div>
                            <div className="p-3 text-center">備考</div>
                        </div>
                        {data.rows.map((row, index) => (
                            <div key={index} className="grid grid-cols-[140px_1fr_1.5fr_2fr_1.5fr_1.5fr] border-b border-slate-200 hover:bg-emerald-50/30 transition-colors group break-inside-avoid">
                                <div className="p-2 border-r border-slate-200"><input className="w-full text-center font-bold text-sm bg-transparent border-none focus:ring-0 p-1" value={row.time} onChange={(e) => handleRowChange(index, 'time', e.target.value)} placeholder="00:00～00:00" /></div>
                                <div className="p-2 border-r border-slate-200 flex items-center justify-center"><input className="w-full text-center font-bold text-slate-700 bg-transparent border-none focus:ring-0 p-1" value={row.scene} onChange={(e) => handleRowChange(index, 'scene', e.target.value)} /></div>
                                <div className="p-2 border-r border-slate-200 flex items-center"><AutoResizeTextarea className="w-full text-sm bg-transparent border-none focus:ring-0 resize-none text-center" value={row.location} onChange={(e) => handleRowChange(index, 'location', e.target.value)} onBlur={() => {}} /></div>
                                <div className="p-2 border-r border-slate-200 flex items-center"><AutoResizeTextarea className="w-full text-sm font-medium bg-transparent border-none focus:ring-0 resize-none" value={row.action} onChange={(e) => handleRowChange(index, 'action', e.target.value)} onBlur={() => {}} /></div>
                                <div className="p-2 border-r border-slate-200 flex items-center"><AutoResizeTextarea className="w-full text-xs bg-transparent border-none focus:ring-0 resize-none text-slate-600" value={row.cast} onChange={(e) => handleRowChange(index, 'cast', e.target.value)} onBlur={() => {}} /></div>
                                <div className="p-2 flex items-center bg-yellow-50/10"><AutoResizeTextarea className="w-full text-xs text-slate-500 bg-transparent border-none focus:ring-0 resize-none" value={row.notes} onChange={(e) => handleRowChange(index, 'notes', e.target.value)} onBlur={() => {}} /></div>
                            </div>
                        ))}
                    </div>
                    <div className="p-4 flex justify-center print:hidden border-t border-slate-200">
                        <button onClick={() => { const newRow = { time: "", scene: "", location: "", action: "", cast: "", notes: "" }; onUpdate({ ...data, rows: [...data.rows, newRow] }); }} className="text-sm text-emerald-600 font-bold hover:text-emerald-700 flex items-center gap-2 px-4 py-2 hover:bg-emerald-50 rounded transition-colors">+ 行を追加</button>
                    </div>
                </div>
            );
        }

        // Main App Component
        function StoryboardApp() {
            const [activeTab, setActiveTab] = useState('patternA');
            const [user, setUser] = useState(null);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [syncError, setSyncError] = useState(null);
            
            // プロジェクトIDの取得（URLから）
            const projectId = getProjectIdFromUrl();
            
            // Initial load from local storage
            const [history, setHistory] = useState(() => {
                const saved = localStorage.getItem(`storyboard_data_${projectId}`);
                return saved ? [JSON.parse(saved)] : [initialProjectData];
            });
            const [historyIndex, setHistoryIndex] = useState(0);
            
            const currentData = history[historyIndex];

            // Setup Auth & Sync
            useEffect(() => {
                if (!auth) {
                    if (globalInitError) setSyncError("設定エラー: " + globalInitError);
                    return;
                }
                const initAuth = async () => {
                    try { 
                        await signInAnonymously(auth); 
                        setSyncError(null);
                    } catch (e) { 
                        console.error("Auth error", e);
                        // エラー内容に応じたメッセージ
                        let msg = "認証エラー: 不明なエラー";
                        if (e.code === 'auth/configuration-not-found') msg = "設定エラー: Firebase設定が無効です";
                        if (e.code === 'auth/admin-restricted-operation') msg = "権限エラー: 匿名認証が許可されていません";
                        if (e.code === 'auth/operation-not-allowed') msg = "許可エラー: この操作は許可されていません";
                        setSyncError(msg);
                    }
                };
                initAuth();
                return onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    if (!u && !globalInitError) {
                        // 接続試行中
                    }
                });
            }, []);

            // Firestore Sync (Listen)
            useEffect(() => {
                if (!user || !db) return;
                const docRef = doc(collection(db, 'projects'), projectId);
                
                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        setHistory(prev => {
                            const current = prev[prev.length - 1];
                            if (JSON.stringify(current) === JSON.stringify(data)) return prev;
                            const newHist = [...prev, data];
                            setHistoryIndex(newHist.length - 1);
                            return newHist;
                        });
                    } else {
                        saveToFirestore(initialProjectData);
                    }
                }, (error) => {
                    console.error("Sync error:", error);
                    if (error.code === 'unavailable') {
                        setSyncError("接続エラー: Firestoreに接続できません。DBが作成されているか確認してください。");
                    } else if (error.code === 'permission-denied') {
                        setSyncError("権限エラー: Firestoreのルールを確認してください。");
                    } else {
                        setSyncError(`同期エラー: ${error.message}`);
                    }
                });
                return () => unsubscribe();
            }, [user, projectId]); // projectIdが変わったら再接続

            // Save Function
            const saveData = async (newData) => {
                localStorage.setItem(`storyboard_data_${projectId}`, JSON.stringify(newData));
                if (user && db) {
                    saveToFirestore(newData);
                }
            };
            
            const saveToFirestore = async (newData) => {
                try {
                    const docRef = doc(collection(db, 'projects'), projectId);
                    await setDoc(docRef, newData);
                    setSyncError(null);
                } catch(e) { 
                    console.error("Cloud save failed", e);
                    setSyncError("保存エラー: クラウドに反映できませんでした");
                }
            };

            const updateData = (newData) => {
                const newHistory = history.slice(0, historyIndex + 1);
                newHistory.push(newData);
                setHistory(newHistory);
                setHistoryIndex(newHistory.length - 1);
                saveData(newData);
            };

            const handleUndo = () => {
                if (historyIndex > 0) {
                    setHistoryIndex(historyIndex - 1);
                    saveData(history[historyIndex - 1]);
                }
            };
            const handleRedo = () => {
                if (historyIndex < history.length - 1) {
                    setHistoryIndex(historyIndex + 1);
                    saveData(history[historyIndex + 1]);
                }
            };

            const updateTabData = (key, val) => updateData({ ...currentData, [key]: val });
            const updateCommon = (key, val) => updateData({ ...currentData, common: { ...currentData.common, [key]: val } });
            
            // 共有リンクのコピー (iframe対策版)
            const handleCopyLink = () => {
                const url = new URL(window.location.href);
                // クエリパラメータを削除してハッシュにする
                url.search = ''; 
                url.hash = projectId;
                const urlString = url.toString();

                const textArea = document.createElement("textarea");
                textArea.value = urlString;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                textArea.style.top = "0";
                
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();

                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        alert(`共有リンクをコピーしました！\n\n${urlString}\n\nこのURLを知っている人とデータを共有できます。`);
                    } else {
                        throw new Error('Copy command failed');
                    }
                } catch (err) {
                    console.error('Fallback: Oops, unable to copy', err);
                    alert('リンクのコピーに失敗しました。手動でコピーしてください:\n' + urlString);
                }
                document.body.removeChild(textArea);
            };
            
            // ID変更ハンドラ
            const handleChangeId = () => {
                const newId = prompt("新しい共有IDを入力してください（半角英数字推奨）:\n※IDを変更すると表示されるデータが切り替わります。", projectId);
                if (newId && newId !== projectId) {
                    window.location.hash = newId;
                    window.location.reload();
                }
            };

            // ステータス表示ロジック
            let statusBadge;
            if (globalInitError || syncError) {
                statusBadge = <span className="text-rose-500 flex items-center gap-1 cursor-pointer hover:underline font-bold" onClick={() => setIsSettingsOpen(true)}><AlertCircle className="w-4 h-4" /> 接続エラー (オフライン)</span>;
            } else if (user) {
                statusBadge = <span className="text-emerald-600 flex items-center gap-1 font-bold"><Wifi className="w-4 h-4" /> オンライン</span>;
            } else if (firebaseConfig) {
                statusBadge = <span className="text-amber-500 flex items-center gap-1 font-bold"><Clock className="w-4 h-4 animate-pulse" /> 接続中...</span>;
            } else {
                statusBadge = <span className="text-slate-400 flex items-center gap-1 font-bold"><HardDrive className="w-4 h-4" /> オフライン</span>;
            }

            return (
                <div className="max-w-[1400px] mx-auto p-4 md:p-6">
                    <div className="mb-6 flex flex-col gap-4 print:hidden">
                        <div className="flex flex-col md:flex-row justify-between items-end gap-4">
                            <div>
                                <h1 className="text-2xl font-bold text-slate-800 flex items-center gap-3">
                                    <span className="bg-indigo-600 text-white p-2 rounded-lg"><FileText className="w-5 h-5" /></span>
                                    動画制作マネージャー
                                </h1>
                                <div className="flex items-center gap-2 mt-2 ml-1 text-sm">
                                    {statusBadge}
                                    <div className="flex items-center gap-1 ml-4 bg-slate-100 px-2 py-1 rounded text-slate-500 hover:bg-slate-200 transition-colors cursor-pointer group" onClick={handleChangeId} title="クリックしてIDを変更 (データが切り替わります)">
                                        <span className="text-xs font-mono">ID: {projectId}</span>
                                        <Edit3 className="w-3 h-3 opacity-0 group-hover:opacity-100" />
                                    </div>
                                    {(globalInitError || syncError) && (
                                        <span className="text-xs text-rose-400 ml-2 cursor-pointer hover:underline" onClick={() => setIsSettingsOpen(true)}>※クリックして詳細を確認</span>
                                    )}
                                </div>
                            </div>
                            <div className="flex gap-2">
                                <div className="flex bg-white rounded-lg border border-slate-200 p-1 shadow-sm">
                                    <button onClick={handleUndo} disabled={historyIndex === 0} className="p-2 rounded hover:bg-slate-100 disabled:opacity-30 text-slate-600"><Undo className="w-4 h-4" /></button>
                                    <button onClick={handleRedo} disabled={historyIndex === history.length - 1} className="p-2 rounded hover:bg-slate-100 disabled:opacity-30 text-slate-600"><Redo className="w-4 h-4" /></button>
                                </div>
                                <button onClick={handleCopyLink} className="flex items-center gap-2 px-5 py-2 text-sm font-semibold text-slate-700 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 shadow-md transition-all"><LinkIcon className="w-4 h-4" /> 共有</button>
                                <button onClick={() => window.print()} className="flex items-center gap-2 px-5 py-2 text-sm font-semibold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 shadow-md transition-all"><Printer className="w-4 h-4" /> 印刷 / PDF</button>
                                <button onClick={() => setIsSettingsOpen(true)} className="flex items-center gap-2 px-3 py-2 text-slate-500 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 hover:text-slate-700 shadow-sm transition-all" title="設定"><Settings className="w-5 h-5" /></button>
                            </div>
                        </div>

                        <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-wrap gap-4 items-center">
                            <div className="flex flex-col gap-1 flex-1 min-w-[200px]">
                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider flex items-center gap-1"><Briefcase className="w-3 h-3" />クライアント名</label>
                                <input className="font-bold text-lg text-slate-800 bg-slate-50 border-b-2 border-slate-200 focus:border-indigo-500 focus:bg-white px-2 py-1 w-full outline-none" value={currentData.common.clientName} onChange={(e) => updateCommon('clientName', e.target.value)} />
                            </div>
                            <div className="flex flex-col gap-1 flex-1 min-w-[200px]">
                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider flex items-center gap-1"><MonitorPlay className="w-3 h-3" />プロジェクト名</label>
                                <input className="font-bold text-lg text-slate-800 bg-slate-50 border-b-2 border-slate-200 focus:border-indigo-500 focus:bg-white px-2 py-1 w-full outline-none" value={currentData.common.projectName} onChange={(e) => updateCommon('projectName', e.target.value)} />
                            </div>
                            <div className="flex flex-col gap-1 min-w-[150px]">
                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider flex items-center gap-1"><CalendarIcon className="w-3 h-3" />撮影日</label>
                                <input type="date" className="font-bold text-lg text-slate-800 bg-slate-50 border-b-2 border-slate-200 focus:border-indigo-500 focus:bg-white px-2 py-1 w-full outline-none cursor-pointer" value={currentData.common.date} onChange={(e) => updateCommon('date', e.target.value)} />
                            </div>
                        </div>

                        <div className="flex gap-1 border-b border-slate-200 overflow-x-auto">
                            {['patternA', 'patternB', 'patternC'].map((tab) => (
                                <button key={tab} onClick={() => setActiveTab(tab)} className={`px-8 py-3 text-lg font-black rounded-t-xl transition-all border-t border-x ${activeTab === tab ? 'bg-white text-indigo-600 border-slate-200 border-b-white translate-y-[1px] shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]' : 'bg-slate-100 text-slate-400 border-transparent hover:bg-slate-200 hover:text-slate-600'}`}>
                                    {tab === 'patternA' ? 'A' : tab === 'patternB' ? 'B' : 'C'}
                                </button>
                            ))}
                            <div className="w-8 border-b border-slate-200"></div>
                            <button onClick={() => setActiveTab('callSheet')} className={`flex items-center gap-2 px-6 py-3 text-sm font-bold rounded-t-xl transition-all border-t border-x ${activeTab === 'callSheet' ? 'bg-white text-emerald-600 border-slate-200 border-b-white translate-y-[1px] shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]' : 'bg-slate-100 text-slate-400 border-transparent hover:bg-slate-200 hover:text-slate-600'}`}>
                                <CalendarIcon className="w-4 h-4" /> 香盤表
                            </button>
                        </div>
                    </div>

                    <div className="bg-white rounded-xl shadow-lg border border-slate-200 overflow-x-auto print:shadow-none print:border-none print:w-full print:max-w-none print:rounded-none min-h-[800px]">
                        {activeTab.startsWith('pattern') ? (
                            <StoryboardEditor data={currentData[activeTab]} common={currentData.common} onUpdate={(d) => updateTabData(activeTab, d)} />
                        ) : (
                            <CallSheetEditor data={currentData.callSheet} common={currentData.common} onUpdate={(d) => updateTabData('callSheet', d)} />
                        )}
                    </div>
                    
                    <div className="mt-8 text-center text-slate-400 text-sm print:hidden pb-12">
                        <p>動画制作マネージャー v17.0 (Firebase Sync Enabled)</p>
                    </div>

                    <SettingsModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} initialError={globalInitError || syncError} />
                </div>
            );
        }

        // Mount
        const root = createRoot(document.getElementById('root'));
        root.render(<StoryboardApp />);
    </script>
</body>
</html>